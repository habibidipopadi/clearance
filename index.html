<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quebec Background Check Form Filler</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .char-counter {
      color: #6c757d;
      font-size: 12px;
      display: block;
      text-align: right;
      margin-top: 2px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .form-section {
      background-color: #f9f9f9;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input[type="text"], 
    input[type="date"],
    input[type="tel"],
    input[type="email"],
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .radio-group {
      display: flex;
      gap: 15px;
    }
    .radio-group label {
      font-weight: normal;
    }
    .btn {
      background-color: #0056b3;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    .btn:hover {
      background-color: #003d7e;
      color: white;
    }
    .btn-secondary {
      background-color: #6c757d;
    }
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    .btn-success {
      background-color: #28a745;
    }
    .btn-success:hover {
      background-color: #218838;
    }
    #status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .loading {
      background-color: #e2e3e5;
      color: #383d41;
      border: 1px solid #d6d8db;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.3);
      border-radius: 50%;
      border-top-color: #0056b3;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .pdf-container {
      margin-top: 20px;
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      display: none;
    }
    .pdf-preview {
      width: 100%;
      height: 800px;
      border: none;
    }
    #signatureCanvas {
      border: 1px solid #ddd;
      background-color: #fff;
      cursor: crosshair;
    }
    .signature-pad {
      margin-top: 10px;
    }
    .signature-actions {
      margin-top: 10px;
    }
    .note {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
      color: #856404;
    }
    
    /* Language toggle switch styles */
    .language-toggle-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    .language-label {
      font-weight: bold;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196F3;
    }
    input:focus + .slider {
      box-shadow: 0 0 1px #2196F3;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    /* Added custom styles for consent text */
    .consent-text {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #0056b3;
      font-size: 0.95em;
      line-height: 1.5;
    }
    .consent-text p {
      margin-bottom: 10px;
    }
    
    /* Email section styles */
    .email-section {
      border: 2px solid #28a745;
      background-color: #f8fff9;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .email-note {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
      color: #0c5460;
      font-size: 0.9em;
    }
    
    .workflow-section {
      background-color: #e7f3ff;
      border: 1px solid #b3d7ff;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .workflow-steps {
      list-style: none;
      padding: 0;
    }
    
    .workflow-steps li {
      margin: 8px 0;
      padding-left: 25px;
      position: relative;
    }
    
    .workflow-steps li:before {
      content: "✓";
      position: absolute;
      left: 0;
      color: #28a745;
      font-weight: bold;
    }
    
    .email-instructions {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
      color: #856404;
    }
    
    .email-instructions h4 {
      margin-top: 0;
      color: #856404;
    }
    
    .email-instructions ol {
      margin-bottom: 0;
      padding-left: 20px;
    }
    
    .email-instructions li {
      margin-bottom: 5px;
    }
    
    .sheets-integration {
      background-color: #e8f5e8;
      border: 1px solid #c8e6c9;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
      color: #2e7d32;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1 id="pageTitle">Quebec Background Check Form Filler</h1>
  
  <!-- Language Toggle -->
  <div class="language-toggle-container">
    <span class="language-label" id="englishLabel">English</span>
    <label class="switch">
      <input type="checkbox" id="languageToggle">
      <span class="slider"></span>
    </label>
    <span class="language-label" id="frenchLabel">Français</span>
  </div>
  
  <div class="note" id="noteContent">
    <p><strong id="noteLabel">Note:</strong> <span id="noteText">Fill out the form below and your completed PDF will be automatically generated using the official Quebec Background Check Form.</span></p>
  </div>

  <!-- Google Sheets Integration Notice -->
  <div class="sheets-integration">
    <p id="sheetsNotice">📊 <strong>Automatic Tracking:</strong> Form submissions are automatically logged to Google Sheets for record keeping.</p>
  </div>

  <!-- Workflow Information -->
  <div class="workflow-section">
    <h3 id="workflowTitle">📋 How It Works</h3>
    <ul class="workflow-steps">
      <li id="step1">Fill out the form and add your digital signature</li>
      <li id="step2">Generate your completed PDF form</li>
      <li id="step3">Download the PDF to your device</li>
      <li id="step4">Click "Send Form" to open your email client and log submission</li>
      <li id="step5">Attach the PDF and send the email</li>
    </ul>
  </div>

  <!-- Involvement and Sobriety Information -->
  <div class="form-section">
    <h2 id="involvementTitle">Involvement Information</h2>
    <div class="form-group">
      <label for="sobrietyDate" id="sobrietyDateLabel">Sobriety Date:</label>
      <input type="date" id="sobrietyDate">
    </div>
    <div class="form-group">
      <label id="involvementLabel">How are you looking to get involved?</label>
      <div style="margin-top: 10px;">
        <div style="margin-bottom: 8px;">
          <input type="checkbox" id="joinCFC" name="involvement">
          <label for="joinCFC" id="joinCFCLabel" style="font-weight: normal; margin-left: 8px;">Join the CFC Committee</label>
        </div>
        <div style="margin-bottom: 8px;">
          <input type="checkbox" id="speakFacility" name="involvement">
          <label for="speakFacility" id="speakFacilityLabel" style="font-weight: normal; margin-left: 8px;">Speak at a Correctional Facility</label>
        </div>
        <div style="margin-bottom: 8px;">
          <input type="checkbox" id="tempContact" name="involvement">
          <label for="tempContact" id="tempContactLabel" style="font-weight: normal; margin-left: 8px;">Become a Temporary Contact for Bridging the Gap</label>
        </div>
        <div style="margin-bottom: 8px;">
          <input type="checkbox" id="seekingInfo" name="involvement">
          <label for="seekingInfo" id="seekingInfoLabel" style="font-weight: normal; margin-left: 8px;">Seeking information</label>
        </div>
      </div>
    </div>
  </div>

  <div class="form-section">
    <h2 id="personalInfoTitle">Personal Information</h2>
    <div class="form-group">
      <label for="nom" id="lastNameLabel">Last Name:</label>
      <input type="text" id="nom" maxlength="40">
      <small class="char-counter"><span id="nomCounter">0</span>/40</small>
    </div>
    <div class="form-group">
      <label for="prenoms" id="firstNameLabel">First Name:</label>
      <input type="text" id="prenoms" maxlength="40">
      <small class="char-counter"><span id="prenomsCounter">0</span>/40</small>
    </div>
    <div class="form-group">
      <label for="nomNaissance" id="birthNameLabel">Name on birth certificate (if different):</label>
      <input type="text" id="nomNaissance" maxlength="50">
      <small class="char-counter"><span id="nomNaissanceCounter">0</span>/50</small>
    </div>
    <div class="form-group">
      <label for="autreNoms" id="otherNamesLabel">Any other names, first names or nicknames:</label>
      <input type="text" id="autreNoms" maxlength="60">
      <small class="char-counter"><span id="autreNomsCounter">0</span>/60</small>
    </div>
    <div class="form-group">
      <label for="dateNaissance" id="dobLabel">Date of Birth (DD/MM/YYYY):</label>
      <input type="date" id="dateNaissance">
    </div>
    <div class="form-group">
      <label id="genderLabel">Gender:</label>
      <div class="radio-group">
        <div>
          <input type="radio" id="sexeMasculin" name="sexe" value="Masculin">
          <label for="sexeMasculin" id="maleLabel">Male</label>
        </div>
        <div>
          <input type="radio" id="sexeFeminin" name="sexe" value="Féminin">
          <label for="sexeFeminin" id="femaleLabel">Female</label>
        </div>
      </div>
    </div>
    <div class="form-group">
      <label for="nomMere" id="motherNameLabel">Mother's Full Name (First and Last):</label>
      <input type="text" id="nomMere" maxlength="50">
      <small class="char-counter"><span id="nomMereCounter">0</span>/50</small>
    </div>
    <div class="form-group">
      <label for="adresse" id="addressLabel">Address - Number, Street, Apartment:</label>
      <input type="text" id="adresse" maxlength="80">
      <small class="char-counter"><span id="adresseCounter">0</span>/80</small>
    </div>
    <div class="form-group">
      <label for="ville" id="cityLabel">City, Province, Postal Code:</label>
      <input type="text" id="ville" maxlength="70">
      <small class="char-counter"><span id="villeCounter">0</span>/70</small>
    </div>
    <div class="form-group">
      <label for="dateAdresse" id="addressDateLabel">Since when have you lived at this address (DD/MM/YYYY):</label>
      <input type="date" id="dateAdresse">
    </div>
    <div class="form-group">
      <label for="telDomicile" id="homePhoneLabel">Home Phone:</label>
      <input type="tel" id="telDomicile" maxlength="20" inputmode="numeric" pattern="[0-9]*">
      <small class="char-counter"><span id="telDomicileCounter">0</span>/20</small>
    </div>
    <div class="form-group">
      <label for="telTravail" id="workPhoneLabel">Work Phone:</label>
      <input type="tel" id="telTravail" maxlength="20" inputmode="numeric" pattern="[0-9]*">
      <small class="char-counter"><span id="telTravailCounter">0</span>/20</small>
    </div>
    <div class="form-group">
      <label for="telAutre" id="otherPhoneLabel">Other Phone Number:</label>
      <input type="tel" id="telAutre" maxlength="20" inputmode="numeric" pattern="[0-9]*">
      <small class="char-counter"><span id="telAutreCounter">0</span>/20</small>
    </div>
    <div class="form-group">
      <label id="crimeLabel">Have you ever been found guilty of a criminal offense in Canada or elsewhere, or are you currently facing prosecution for such an offense?</label>
      <div class="radio-group">
        <div>
          <input type="radio" id="infNon" name="infraction" value="Non">
          <label for="infNon" id="noLabel">No</label>
        </div>
        <div>
          <input type="radio" id="infOui" name="infraction" value="Oui">
          <label for="infOui" id="yesLabel">Yes</label>
        </div>
      </div>
    </div>
    <div class="form-group" id="infraDetail" style="display:none;">
      <label for="infractionDetails" id="infractionDetailsLabel">If yes, please specify:</label>
      <input type="text" id="infractionDetails" maxlength="150">
      <small class="char-counter"><span id="infractionDetailsCounter">0</span>/150</small>
    </div>
  </div>

  <div class="form-section">
    <h2 id="signatureTitle">Digital Signature</h2>
    
    <!-- Added consent text -->
    <div class="form-group">
      <div class="consent-text">
        <p>I, the undersigned, hereby consent to the Directorate General of Correctional Services of the Ministry of Public Security collecting information about my judicial and correctional background. This information will be used solely for the security screening required to authorize my access to individuals, locations, and sensitive information. I have been informed that only persons duly authorized by the Directorate General of Correctional Services have access to this information.</p>
        <p>I, the undersigned, understand that the verification of my judicial and correctional background by the Directorate General of Correctional Services is a prerequisite for authorizing my access to individuals, locations, and sensitive information. In addition, I agree to inform the Directorate General of Correctional Services of any conviction under a law in force in Quebec during my employment contract, internship, or visit.</p>
      </div>
    </div>
    
    <div class="form-group">
      <label for="dateSignature" id="signDateLabel">Signature Date (DD/MM/YYYY):</label>
      <input type="date" id="dateSignature">
    </div>
    <div class="form-group">
      <label id="yourSignatureLabel">Your Signature:</label>
      <div class="signature-pad">
        <canvas id="signatureCanvas" width="600" height="150"></canvas>
        <div class="signature-actions">
          <button id="clearSignature" class="btn btn-secondary">Clear Signature</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Submission Section -->
  <div class="form-section email-section">
    <h2 id="emailTitle">📧 Email Submission</h2>
    <div class="email-note">
      <p id="emailNote">After generating your PDF, use the "Send Form" button to open your email client with a pre-filled message to correctionalfacilities@aa87.org.</p>
    </div>
    <div class="form-group">
      <label for="userEmail" id="emailLabel">Your Email Address:</label>
      <input type="email" id="userEmail" placeholder="your.email@example.com">
    </div>
    <div class="form-group">
      <label for="phoneNumber" id="phoneLabel">Your Phone Number (optional):</label>
      <input type="tel" id="phoneNumber" placeholder="(123) 456-7890">
    </div>
  </div>

  <div class="button-group">
    <button type="button" id="fillPdfBtn" class="btn">Generate Completed Form</button>
    <button type="button" id="resetFormBtn" class="btn btn-secondary">Reset Form</button>
  </div>

  <div id="status"></div>

  <div id="pdfContainer" class="pdf-container">
    <h3 id="completedFormTitle">Your completed form is ready!</h3>
    <p id="downloadInstructions">Download your PDF and send it via email.</p>
    
    <div class="email-instructions">
      <h4 id="instructionsTitle">📧 Email Instructions:</h4>
      <ol id="instructionsList">
        <li id="instruction1"><strong>Download the PDF first</strong></li>
        <li id="instruction2">Click "Send Form" to open your email client and log submission</li>
        <li id="instruction3"><strong>⚠️ IMPORTANT: Attach the PDF file to the email</strong></li>
        <li id="instruction4">Send the email</li>
      </ol>
      <p id="attachmentReminder" style="color: #d63384; font-weight: bold; margin-top: 10px;">
        📎 Remember: You must manually attach the PDF file before sending!
      </p>
    </div>
    
    <div class="button-group">
      <button id="downloadPdfBtn" class="btn">Download PDF</button>
      <button id="printPdfBtn" class="btn btn-secondary">Print PDF</button>
      <button id="sendFormBtn" class="btn btn-success">📧 Send Form & Log Submission</button>
    </div>
    <div style="margin-top: 20px;">
      <iframe id="pdfPreview" class="pdf-preview"></iframe>
    </div>
  </div>

  <script>
    // Google Apps Script Web App URL - Connected to your Google Sheet
    const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbx4qNmKCpsZHVHF2EwDlD1wihJ3MQiRGtl_xaNBGr6v5IW5XX8WWLrLYRmT01iaNiXJ/exec';
    // Language translations
    const translations = {
      english: {
        pageTitle: "Quebec Background Check Form Filler",
        noteLabel: "Note:",
        noteText: "Fill out the form below and your completed PDF will be automatically generated using the official Quebec Background Check Form.",
        sheetsNotice: "📊 Automatic Tracking: Form submissions are automatically logged to Google Sheets for record keeping.",
        workflowTitle: "📋 How It Works",
        step1: "Fill out the form and add your digital signature",
        step2: "Generate your completed PDF form",
        step3: "Download the PDF to your device",
        step4: "Click \"Send Form\" to open your email client and log submission",
        step5: "Attach the PDF and send the email",
        involvementTitle: "Involvement Information",
        sobrietyDateLabel: "Sobriety Date:",
        involvementLabel: "How are you looking to get involved?",
        joinCFCLabel: "Join the CFC Committee",
        speakFacilityLabel: "Speak at a Correctional Facility",
        tempContactLabel: "Become a Temporary Contact for Bridging the Gap",
        seekingInfoLabel: "Seeking information",
        personalInfoTitle: "Personal Information",
        lastNameLabel: "Last Name:",
        firstNameLabel: "First Name:",
        birthNameLabel: "Name on birth certificate (if different):",
        otherNamesLabel: "Any other names, first names or nicknames:",
        dobLabel: "Date of Birth (DD/MM/YYYY):",
        genderLabel: "Gender:",
        maleLabel: "Male",
        femaleLabel: "Female",
        motherNameLabel: "Mother's Full Name (First and Last):",
        addressLabel: "Address - Number, Street, Apartment:",
        cityLabel: "City, Province, Postal Code:",
        addressDateLabel: "Since when have you lived at this address (DD/MM/YYYY):",
        homePhoneLabel: "Home Phone:",
        workPhoneLabel: "Work Phone:",
        otherPhoneLabel: "Other Phone Number:",
        crimeLabel: "Have you ever been found guilty of a criminal offense in Canada or elsewhere, or are you currently facing prosecution for such an offense?",
        noLabel: "No",
        yesLabel: "Yes",
        infractionDetailsLabel: "If yes, please specify:",
        signatureTitle: "Digital Signature",
        signDateLabel: "Signature Date (DD/MM/YYYY):",
        yourSignatureLabel: "Your Signature:",
        clearSignature: "Clear Signature",
        emailTitle: "📧 Email Submission",
        emailNote: "After generating your PDF, use the \"Send Form\" button to open your email client with a pre-filled message to correctionalfacilities@aa87.org.",
        emailLabel: "Your Email Address:",
        phoneLabel: "Your Phone Number (optional):",
        fillPdfBtn: "Generate Completed Form",
        resetFormBtn: "Reset Form",
        completedFormTitle: "Your completed form is ready!",
        downloadInstructions: "Download your PDF and send it via email.",
        instructionsTitle: "📧 Email Instructions:",
        instruction1: "<strong>Download the PDF first</strong>",
        instruction2: "Click \"Send Form\" to open your email client and log submission",
        instruction3: "<strong>⚠️ IMPORTANT: Attach the PDF file to the email</strong>",
        instruction4: "Send the email",
        downloadPdfBtn: "Download PDF",
        printPdfBtn: "Print PDF",
        sendFormBtn: "📧 Send Form & Log Submission",
        attachmentReminder: "📎 Remember: You must manually attach the PDF file before sending!",
        // Status messages
        processingMsg: "Generating your form... Please wait.",
        signatureRequired: "Please sign the form before generating the PDF.",
        pdfLoadError: "Error loading the PDF template. Please try again.",
        signatureError: "Error adding signature to the PDF.",
        pdfSuccess: "PDF form has been successfully generated!",
        pdfError: "Error processing the PDF: ",
        loggingSubmission: "Logging submission to Google Sheets...",
        loggedSuccess: "Submission logged successfully!",
        loggedError: "Error logging submission: "
      },
      french: {
        pageTitle: "Formulaire de vérification d'antécédents du Québec",
        noteLabel: "Remarque :",
        noteText: "Remplissez le formulaire ci-dessous et votre PDF complété sera automatiquement généré en utilisant le formulaire officiel de vérification des antécédents du Québec.",
        sheetsNotice: "📊 Suivi automatique : Les soumissions de formulaires sont automatiquement enregistrées dans Google Sheets pour la tenue de dossiers.",
        workflowTitle: "📋 Comment ça marche",
        step1: "Remplissez le formulaire et ajoutez votre signature numérique",
        step2: "Générez votre formulaire PDF complété",
        step3: "Téléchargez le PDF sur votre appareil",
        step4: "Cliquez sur \"Envoyer le formulaire\" pour ouvrir votre client de messagerie et enregistrer la soumission",
        step5: "Joignez le PDF et envoyez le courriel",
        involvementTitle: "Informations sur l'implication",
        sobrietyDateLabel: "Date de sobriété :",
        involvementLabel: "Comment souhaitez-vous vous impliquer ?",
        joinCFCLabel: "Rejoindre le comité CFC",
        speakFacilityLabel: "Parler dans un établissement correctionnel",
        tempContactLabel: "Devenir un contact temporaire pour combler l'écart",
        seekingInfoLabel: "Recherche d'informations",
        personalInfoTitle: "Informations personnelles",
        lastNameLabel: "Nom de famille :",
        firstNameLabel: "Prénom :",
        birthNameLabel: "Nom sur l'acte de naissance (si différent) :",
        otherNamesLabel: "Autres noms, prénoms ou surnoms :",
        dobLabel: "Date de naissance (JJ/MM/AAAA) :",
        genderLabel: "Sexe :",
        maleLabel: "Masculin",
        femaleLabel: "Féminin",
        motherNameLabel: "Nom complet de la mère (prénom et nom) :",
        addressLabel: "Adresse - Numéro, rue, appartement :",
        cityLabel: "Ville, province, code postal :",
        addressDateLabel: "Depuis quand habitez-vous à cette adresse (JJ/MM/AAAA) :",
        homePhoneLabel: "Téléphone domicile :",
        workPhoneLabel: "Téléphone travail :",
        otherPhoneLabel: "Autre numéro de téléphone :",
        crimeLabel: "Avez-vous déjà été reconnu coupable d'une infraction criminelle au Canada ou ailleurs, ou faites-vous actuellement l'objet de poursuites pour une telle infraction ?",
        noLabel: "Non",
        yesLabel: "Oui",
        infractionDetailsLabel: "Si oui, veuillez préciser :",
        signatureTitle: "Signature numérique",
        signDateLabel: "Date de signature (JJ/MM/AAAA) :",
        yourSignatureLabel: "Votre signature :",
        clearSignature: "Effacer la signature",
        emailTitle: "📧 Soumission par courriel",
        emailNote: "Après avoir généré votre PDF, utilisez le bouton \"Envoyer le formulaire\" pour ouvrir votre client de messagerie avec un message pré-rempli à correctionalfacilities@aa87.org.",
        emailLabel: "Votre adresse courriel :",
        phoneLabel: "Votre numéro de téléphone (optionnel) :",
        fillPdfBtn: "Générer le formulaire complété",
        resetFormBtn: "Réinitialiser le formulaire",
        completedFormTitle: "Votre formulaire complété est prêt !",
        downloadInstructions: "Téléchargez votre PDF et envoyez-le par courriel.",
        instructionsTitle: "📧 Instructions pour le courriel :",
        instruction1: "<strong>Téléchargez d'abord le PDF</strong>",
        instruction2: "Cliquez sur \"Envoyer le formulaire\" pour ouvrir votre client de messagerie et enregistrer la soumission",
        instruction3: "<strong>⚠️ IMPORTANT : Joignez le fichier PDF au courriel</strong>",
        instruction4: "Envoyez le courriel",
        downloadPdfBtn: "Télécharger le PDF",
        printPdfBtn: "Imprimer le PDF",
        sendFormBtn: "📧 Envoyer le formulaire et enregistrer",
        attachmentReminder: "📎 Rappel : Vous devez joindre manuellement le fichier PDF avant d'envoyer !",
        // Status messages
        processingMsg: "Génération de votre formulaire... Veuillez patienter.",
        signatureRequired: "Veuillez signer le formulaire avant de générer le PDF.",
        pdfLoadError: "Erreur lors du chargement du modèle PDF. Veuillez réessayer.",
        signatureError: "Erreur lors de l'ajout de la signature au PDF.",
        pdfSuccess: "Le formulaire PDF a été généré avec succès !",
        pdfError: "Erreur lors du traitement du PDF : ",
        loggingSubmission: "Enregistrement de la soumission dans Google Sheets...",
        loggedSuccess: "Soumission enregistrée avec succès !",
        loggedError: "Erreur lors de l'enregistrement de la soumission : "
      }
    };

    // Variables to store PDF data
    let pdfBytes = null;
    let generatedPdfBytes = null;

    // Function to change language
    function setLanguage(language) {
      const texts = translations[language];
      
      // Update all text elements
      document.getElementById('pageTitle').textContent = texts.pageTitle;
      document.getElementById('noteLabel').textContent = texts.noteLabel;
      document.getElementById('noteText').textContent = texts.noteText;
      document.getElementById('sheetsNotice').textContent = texts.sheetsNotice;
      document.getElementById('workflowTitle').textContent = texts.workflowTitle;
      document.getElementById('step1').textContent = texts.step1;
      document.getElementById('step2').textContent = texts.step2;
      document.getElementById('step3').textContent = texts.step3;
      document.getElementById('step4').textContent = texts.step4;
      document.getElementById('step5').textContent = texts.step5;
      document.getElementById('involvementTitle').textContent = texts.involvementTitle;
      document.getElementById('sobrietyDateLabel').textContent = texts.sobrietyDateLabel;
      document.getElementById('involvementLabel').textContent = texts.involvementLabel;
      document.getElementById('joinCFCLabel').textContent = texts.joinCFCLabel;
      document.getElementById('speakFacilityLabel').textContent = texts.speakFacilityLabel;
      document.getElementById('tempContactLabel').textContent = texts.tempContactLabel;
      document.getElementById('seekingInfoLabel').textContent = texts.seekingInfoLabel;
      document.getElementById('personalInfoTitle').textContent = texts.personalInfoTitle;
      document.getElementById('lastNameLabel').textContent = texts.lastNameLabel;
      document.getElementById('firstNameLabel').textContent = texts.firstNameLabel;
      document.getElementById('birthNameLabel').textContent = texts.birthNameLabel;
      document.getElementById('otherNamesLabel').textContent = texts.otherNamesLabel;
      document.getElementById('dobLabel').textContent = texts.dobLabel;
      document.getElementById('genderLabel').textContent = texts.genderLabel;
      document.getElementById('maleLabel').textContent = texts.maleLabel;
      document.getElementById('femaleLabel').textContent = texts.femaleLabel;
      document.getElementById('motherNameLabel').textContent = texts.motherNameLabel;
      document.getElementById('addressLabel').textContent = texts.addressLabel;
      document.getElementById('cityLabel').textContent = texts.cityLabel;
      document.getElementById('addressDateLabel').textContent = texts.addressDateLabel;
      document.getElementById('homePhoneLabel').textContent = texts.homePhoneLabel;
      document.getElementById('workPhoneLabel').textContent = texts.workPhoneLabel;
      document.getElementById('otherPhoneLabel').textContent = texts.otherPhoneLabel;
      document.getElementById('crimeLabel').textContent = texts.crimeLabel;
      document.getElementById('noLabel').textContent = texts.noLabel;
      document.getElementById('yesLabel').textContent = texts.yesLabel;
      document.getElementById('infractionDetailsLabel').textContent = texts.infractionDetailsLabel;
      document.getElementById('signatureTitle').textContent = texts.signatureTitle;
      document.getElementById('signDateLabel').textContent = texts.signDateLabel;
      document.getElementById('yourSignatureLabel').textContent = texts.yourSignatureLabel;
      document.getElementById('clearSignature').textContent = texts.clearSignature;
      document.getElementById('emailTitle').textContent = texts.emailTitle;
      document.getElementById('emailNote').textContent = texts.emailNote;
      document.getElementById('emailLabel').textContent = texts.emailLabel;
      document.getElementById('phoneLabel').textContent = texts.phoneLabel;
      document.getElementById('fillPdfBtn').textContent = texts.fillPdfBtn;
      document.getElementById('resetFormBtn').textContent = texts.resetFormBtn;
      document.getElementById('completedFormTitle').textContent = texts.completedFormTitle;
      document.getElementById('downloadInstructions').textContent = texts.downloadInstructions;
      document.getElementById('instructionsTitle').textContent = texts.instructionsTitle;
      document.getElementById('instruction1').innerHTML = texts.instruction1;
      document.getElementById('instruction2').innerHTML = texts.instruction2;
      document.getElementById('instruction3').innerHTML = texts.instruction3;
      document.getElementById('instruction4').innerHTML = texts.instruction4;
      document.getElementById('downloadPdfBtn').textContent = texts.downloadPdfBtn;
      document.getElementById('printPdfBtn').textContent = texts.printPdfBtn;
      document.getElementById('sendFormBtn').textContent = texts.sendFormBtn;
      document.getElementById('attachmentReminder').textContent = texts.attachmentReminder;
      
      // Update document language attribute
      document.documentElement.lang = language === 'english' ? 'en' : 'fr';
    }

    // Language toggle event listener
    document.getElementById('languageToggle').addEventListener('change', function() {
      const language = this.checked ? 'french' : 'english';
      setLanguage(language);
    });

    // Handle infraction details display
    document.querySelectorAll('input[name="infraction"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const infraDetail = document.getElementById('infraDetail');
        if (this.value === 'Oui') {
          infraDetail.style.display = 'block';
        } else {
          infraDetail.style.display = 'none';
        }
      });
    });

    // Initialize signature pad
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let signatureData = null;

    // Setup canvas for drawing
    ctx.lineWidth = 2;
    ctx.strokeStyle = "black";
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Add event listeners for drawing
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events for mobile
    canvas.addEventListener('touchstart', startDrawingTouch);
    canvas.addEventListener('touchmove', drawTouch);
    canvas.addEventListener('touchend', stopDrawing);

    // Drawing functions
    function startDrawing(e) {
      isDrawing = true;
      draw(e);
    }

    function startDrawingTouch(e) {
      isDrawing = true;
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
      e.preventDefault();
    }

    function draw(e) {
      if (!isDrawing) return;
      
      ctx.lineCap = 'round';
      
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function drawTouch(e) {
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
      e.preventDefault();
    }

    function stopDrawing() {
      if (isDrawing) {
        ctx.beginPath();
        isDrawing = false;
        // Save signature data
        signatureData = canvas.toDataURL('image/png');
      }
    }

    // Clear signature button
    document.getElementById('clearSignature').addEventListener('click', function() {
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      signatureData = null;
    });

    // Reset form button
    document.getElementById('resetFormBtn').addEventListener('click', function() {
      // Reset all form fields
      document.querySelectorAll('input[type="text"], input[type="tel"], input[type="date"], input[type="email"]').forEach(input => {
        input.value = '';
      });
      
      document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
        input.checked = false;
      });
      
      // Hide conditional fields
      document.getElementById('infraDetail').style.display = 'none';
      
      // Clear signature
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      signatureData = null;
      
      // Hide PDF container
      document.getElementById('pdfContainer').style.display = 'none';
      
      // Clear status
      document.getElementById('status').style.display = 'none';
      
      // Reset generated PDF
      generatedPdfBytes = null;
    });

    // Auto-load PDF on page load
    async function loadPDF() {
      try {
        // Load the PDF from the same directory
        const response = await fetch('./Provincial consent form.pdf');
        if (!response.ok) {
          throw new Error('PDF not found');
        }
        const arrayBuffer = await response.arrayBuffer();
        pdfBytes = new Uint8Array(arrayBuffer);
        console.log('PDF template loaded successfully');
      } catch (error) {
        console.error('Error loading PDF:', error);
        const language = document.getElementById('languageToggle').checked ? 'french' : 'english';
        showStatus('error', translations[language].pdfLoadError);
      }
    }

    // Fill PDF function
    async function fillPDF() {
      const language = document.getElementById('languageToggle').checked ? 'french' : 'english';
      const texts = translations[language];
      
      // Validate signature
      if (!signatureData) {
        alert(texts.signatureRequired);
        return;
      }
      
      // Check if PDF is loaded
      if (!pdfBytes) {
        await loadPDF();
        if (!pdfBytes) {
          return;
        }
      }
      
      showStatus('loading', texts.processingMsg);
      
      try {
        const { PDFDocument, rgb, StandardFonts } = PDFLib;
        
        // Load the existing PDF
        const pdfDoc = await PDFDocument.load(pdfBytes);
        
        // Get the first page of the document
        const pages = pdfDoc.getPages();
        const page = pages[0];
        
        // Get a font
        const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
        
        // Format dates (DD/MM/YYYY)
        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        };
        
        // Get form values
        const nom = document.getElementById('nom').value;
        const prenoms = document.getElementById('prenoms').value;
        const nomNaissance = document.getElementById('nomNaissance').value;
        const autreNoms = document.getElementById('autreNoms').value;
        const dateNaissance = formatDate(document.getElementById('dateNaissance').value);
        
        const sexe = document.querySelector('input[name="sexe"]:checked');
        const sexeValue = sexe ? sexe.value : '';
        
        const nomMere = document.getElementById('nomMere').value;
        const adresse = document.getElementById('adresse').value;
        const ville = document.getElementById('ville').value;
        const dateAdresse = formatDate(document.getElementById('dateAdresse').value);
        const telDomicile = document.getElementById('telDomicile').value;
        const telTravail = document.getElementById('telTravail').value;
        const telAutre = document.getElementById('telAutre').value;
        
        const infraction = document.querySelector('input[name="infraction"]:checked');
        const infractionValue = infraction ? infraction.value : '';
        const infractionDetail = document.getElementById('infractionDetails').value;
        
        const dateSignature = formatDate(document.getElementById('dateSignature').value);
        
        // Set coordinates for text placement on the PDF
        // Section 2 - Personal Information
        // Last name
        page.drawText(nom, { x: 170, y: 648, size: 10, font });
        
        // First names
        page.drawText(prenoms, { x: 170, y: 700, size: 10, font });
        
        // Birth name
        page.drawText(nomNaissance, { x: 400, y: 680, size: 10, font });
        
        // Other names
        page.drawText(autreNoms, { x: 400, y: 648, size: 10, font });
        
        // Date of birth
        if (dateNaissance) {
          const [day, month, year] = dateNaissance.split('/');
          page.drawText(day, { x: 50, y: 610, size: 10, font });
          page.drawText(month, { x: 70, y: 610, size: 10, font });
          page.drawText(year, { x: 100, y: 610, size: 10, font });
        }
        
        // Gender
        if (sexeValue === 'Masculin') {
          page.drawText('X', { x: 170, y: 610, size: 12, font });
        } else if (sexeValue === 'Féminin') {
          page.drawText('X', { x: 220, y: 610, size: 12, font });
        }
        
        // Mother's name
        page.drawText(nomMere, { x: 400, y: 605, size: 10, font });
        
        // Address
        page.drawText(adresse, { x: 150, y: 560, size: 10, font });
        
        // City, province, postal code
        page.drawText(ville, { x: 400, y: 580, size: 10, font });
        
        // Since when at address
        if (dateAdresse) {
          const [day, month, year] = dateAdresse.split('/');
          page.drawText(day, { x: 50, y: 530, size: 10, font });
          page.drawText(month, { x: 70, y: 530, size: 10, font });
          page.drawText(year, { x: 100, y: 530, size: 10, font });
        }
        
        // Phone numbers
        page.drawText(telDomicile, { x: 400, y: 536, size: 10, font });
        page.drawText(telTravail, { x: 390, y: 524, size: 10, font });
        page.drawText(telAutre, { x: 410, y: 516, size: 10, font });
        
        // Criminal history
        if (infractionValue === 'Non') {
          page.drawText('X', { x: 58, y: 455, size: 12, font });
        } else if (infractionValue === 'Oui') {
          page.drawText('X', { x: 88, y: 455, size: 12, font });
          page.drawText(infractionDetail, { x: 110, y: 440, size: 10, font });
        }
        
        // Signature date (for both Parts B and C)
        if (dateSignature) {
          // For Part B
          const [day1, month1, year1] = dateSignature.split('/');
          page.drawText(day1, { x: 380, y: 260, size: 10, font });
          page.drawText(month1, { x: 405, y: 260, size: 10, font });
          page.drawText(year1, { x: 435, y: 260, size: 10, font });
          
          // For Part C
          const [day2, month2, year2] = dateSignature.split('/');
          page.drawText(day2, { x: 385, y: 180, size: 10, font });
          page.drawText(month2, { x: 410, y: 180, size: 10, font });
          page.drawText(year2, { x: 435, y: 180, size: 10, font });
        }
        
        // Add signature image for both signature lines
        try {
          // Convert signature data URL to bytes
          const signatureImageBytes = await fetch(signatureData).then(res => res.arrayBuffer());
          const signatureImage = await pdfDoc.embedPng(signatureImageBytes);
          
          // Size the signature appropriately
          const signatureDims = signatureImage.scale(0.2); // Scale signature to 20% of original size
          
          // Add signature to Part B
          page.drawImage(signatureImage, {
            x: 170,
            y: 250,
            width: signatureDims.width,
            height: signatureDims.height,
          });
          
          // Add signature to Part C
          page.drawImage(signatureImage, {
            x: 170,
            y: 170,
            width: signatureDims.width,
            height: signatureDims.height,
          });
        } catch (error) {
          console.error('Error embedding signature:', error);
          showStatus('error', texts.signatureError);
          return;
        }
        
        // Save the modified PDF
        const modifiedPdfBytes = await pdfDoc.save();
        generatedPdfBytes = modifiedPdfBytes;
        
        // Create a blob from the PDF bytes
        const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        // Set the PDF preview
        document.getElementById('pdfPreview').src = url;
        document.getElementById('pdfContainer').style.display = 'block';
        
        // Set up download button
        document.getElementById('downloadPdfBtn').onclick = function() {
          download(modifiedPdfBytes, 'filled_consent_form.pdf', 'application/pdf');
        };
        
        // Set up print button
        document.getElementById('printPdfBtn').onclick = function() {
          const iframe = document.getElementById('pdfPreview');
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
        };
        
        // Set up send form button with Google Sheets integration
        document.getElementById('sendFormBtn').onclick = sendFormAndLogSubmission;
        
        showStatus('success', texts.pdfSuccess);
        
      } catch (error) {
        console.error('Error processing PDF:', error);
        showStatus('error', texts.pdfError + error.message);
      }
    }

    // Send form and log submission to Google Sheets
    async function sendFormAndLogSubmission() {
      const language = document.getElementById('languageToggle').checked ? 'french' : 'english';
      const texts = translations[language];
      
      // Log submission to Google Sheets first
      showStatus('loading', texts.loggingSubmission);
      
      try {
        await logSubmissionToSheets();
        showStatus('success', texts.loggedSuccess);
        
        // Wait a moment for user to see the success message
        setTimeout(() => {
          openMailtoLink();
        }, 1000);
        
      } catch (error) {
        console.error('Sheets logging error:', error);
        showStatus('error', texts.loggedError + error.message);
        
        // Still open the mailto link even if logging fails
        setTimeout(() => {
          openMailtoLink();
        }, 2000);
      }
    }

// CORS-Free submission function - replace your existing logSubmissionToSheets function
async function logSubmissionToSheets() {
  const userEmail = document.getElementById('userEmail').value || 'Not provided';
  const userPhone = document.getElementById('phoneNumber').value || 'Not provided';
  const applicantName = `${document.getElementById('prenoms').value} ${document.getElementById('nom').value}`;
  
  // Get involvement checkboxes
  const involvementOptions = [];
  if (document.getElementById('joinCFC').checked) involvementOptions.push('Join the CFC Committee');
  if (document.getElementById('speakFacility').checked) involvementOptions.push('Speak at a Correctional Facility');
  if (document.getElementById('tempContact').checked) involvementOptions.push('Become a Temporary Contact for Bridging the Gap');
  if (document.getElementById('seekingInfo').checked) involvementOptions.push('Seeking information');
  
  // Prepare data as URL parameters (avoids CORS preflight)
  const params = new URLSearchParams({
    applicantName: applicantName,
    firstName: document.getElementById('prenoms').value,
    lastName: document.getElementById('nom').value,
    gender: document.querySelector('input[name="sexe"]:checked')?.value || '',
    sobrietyDate: document.getElementById('sobrietyDate').value,
    involvement: involvementOptions.join(', '),
    signatureDate: document.getElementById('dateSignature').value,
    userEmail: userEmail,
    userPhone: userPhone
  });
  
  // Use GET request to avoid CORS preflight
  const response = await fetch(`${GOOGLE_SHEETS_URL}?${params.toString()}`, {
    method: 'GET',
    mode: 'cors'
  });
  
  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }
  
  const result = await response.json();
  if (result.status !== 'success') {
    throw new Error(result.message || 'Unknown error occurred');
  }
  
  return result;
}

    // Open mailto link
    function openMailtoLink() {
      const userEmail = document.getElementById('userEmail').value || 'your.email@example.com';
      const userPhone = document.getElementById('phoneNumber').value || 'Not provided';
      const applicantName = `${document.getElementById('prenoms').value} ${document.getElementById('nom').value}`;
      const submissionDate = new Date().toLocaleDateString();
      
      // Format subject with applicant name and date: "John Smith Clearance Form Application 6/11/2025"
      const subject = encodeURIComponent(`${applicantName} Clearance Form Application ${submissionDate}`);
      const body = encodeURIComponent(`Hello,

I am submitting my completed Quebec Background Check Form as requested.

Applicant Details:
- Name: ${applicantName}
- Email: ${userEmail}
- Phone: ${userPhone}
- Submission Date: ${submissionDate}

⚠️ IMPORTANT: Please remember to attach the PDF file before sending this email.

The completed PDF form should be attached to this email. If you need any additional information, please contact me at ${userEmail}.

Thank you for your time.

Best regards,
${applicantName}`);
      
      const mailtoLink = `mailto:correctionalfacilities@aa87.org?subject=${subject}&body=${body}`;
      window.open(mailtoLink);
    }

    // Helper function to show status messages
    function showStatus(type, message) {
      const statusElement = document.getElementById('status');
      statusElement.className = type;
      statusElement.style.display = 'block';
      
      if (type === 'loading') {
        statusElement.innerHTML = `<div class="spinner"></div> ${message}`;
      } else {
        statusElement.textContent = message;
      }
      
      // Auto-hide non-loading status after 5 seconds
      if (type !== 'loading') {
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 5000);
      }
    }

    // Add JavaScript validation for numeric-only phone fields
    const phoneFields = ['telDomicile', 'telTravail', 'telAutre'];
    
    phoneFields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      
      field.addEventListener('input', function(e) {
        // Remove any non-numeric characters
        const numericValue = this.value.replace(/[^0-9]/g, '');
        
        // Update the field value if it changed
        if (this.value !== numericValue) {
          this.value = numericValue;
          
          // Update the character counter
          const counterElement = document.getElementById(`${fieldId}Counter`);
          if (counterElement) {
            counterElement.textContent = numericValue.length;
          }
        }
      });
    });

    // Character counter functionality
    const textInputs = [
      { id: 'nom', maxLength: 40 },
      { id: 'prenoms', maxLength: 40 },
      { id: 'nomNaissance', maxLength: 50 },
      { id: 'autreNoms', maxLength: 60 },
      { id: 'nomMere', maxLength: 50 },
      { id: 'adresse', maxLength: 80 },
      { id: 'ville', maxLength: 70 },
      { id: 'telDomicile', maxLength: 20 },
      { id: 'telTravail', maxLength: 20 },
      { id: 'telAutre', maxLength: 20 },
      { id: 'infractionDetails', maxLength: 150 }
    ];

    // Add input event listeners to update character counters
    textInputs.forEach(input => {
      const inputElement = document.getElementById(input.id);
      const counterElement = document.getElementById(`${input.id}Counter`);
      
      if (inputElement && counterElement) {
        // Update counter initially
        counterElement.textContent = inputElement.value.length;
        
        // Add input event listener
        inputElement.addEventListener('input', function() {
          counterElement.textContent = this.value.length;
          
          // Change counter color when approaching limit
          const charCount = this.value.length;
          const percent = charCount / input.maxLength;
          
          if (percent >= 0.9) {
            counterElement.parentElement.style.color = '#dc3545'; // Red when near limit
          } else if (percent >= 0.7) {
            counterElement.parentElement.style.color = '#fd7e14'; // Orange when getting close
          } else {
            counterElement.parentElement.style.color = '#6c757d'; // Default gray
          }
        });
      }
    });

    // Attach event listeners
    document.getElementById('fillPdfBtn').addEventListener('click', fillPDF);
    
    // Initialize language to English and load PDF
    setLanguage('english');
    loadPDF();
  </script>
</body>
</html>
