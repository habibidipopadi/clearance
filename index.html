<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quebec Background Check Form</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f8fafc;
      padding: 20px 0;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      padding: 32px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .header p {
      opacity: 0.9;
      font-size: 16px;
    }

    .language-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
    }

    .language-label {
      font-weight: 500;
      font-size: 14px;
    }

    .switch {
      position: relative;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.3);
      transition: .3s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: rgba(255, 255, 255, 0.5);
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }

    .form-content {
      padding: 40px;
    }

    .section {
      margin-bottom: 40px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
    }

    .section-number {
      background: #3b82f6;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 600;
      color: #1f2937;
    }

    .form-grid {
      display: grid;
      gap: 20px;
    }

    .form-grid.two-column {
      grid-template-columns: 1fr 1fr;
    }

    @media (max-width: 768px) {
      .form-grid.two-column {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
      font-size: 14px;
    }

    .required {
      color: #ef4444;
    }

    input[type="text"],
    input[type="date"],
    input[type="tel"],
    input[type="email"],
    input[type="file"],
    select {
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.2s;
      background: white;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="tel"]:focus,
    input[type="email"]:focus,
    input[type="file"]:focus,
    select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    select {
      cursor: pointer;
    }

    input::placeholder {
      color: #9ca3af;
    }

    /* File Upload Styling */
    input[type="file"] {
      padding: 8px 12px;
      border: 2px dashed #d1d5db;
      background: #f9fafb;
      cursor: pointer;
    }

    input[type="file"]:hover {
      border-color: #3b82f6;
      background: #f0f9ff;
    }

    input[type="file"]:focus {
      border-style: solid;
      border-color: #3b82f6;
    }

    .file-upload-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
      font-style: italic;
    }

    .phone-input-container {
      position: relative;
    }

    .phone-validation-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      display: none;
    }

    .phone-validation-icon.valid {
      color: #10b981;
      display: block;
    }

    .phone-validation-icon.invalid {
      color: #ef4444;
      display: block;
    }

    .phone-input.valid {
      border-color: #10b981;
      background-color: #f0fdf4;
    }

    .phone-input.invalid {
      border-color: #ef4444;
      background-color: #fef2f2;
    }

    .phone-format-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
      font-style: italic;
    }

    .phone-error-message {
      font-size: 12px;
      color: #ef4444;
      margin-top: 4px;
      display: none;
    }

    .char-counter {
      font-size: 12px;
      color: #6b7280;
      text-align: right;
      margin-top: 4px;
    }

    .radio-group {
      display: flex;
      gap: 24px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .radio-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .radio-item input[type="radio"] {
      width: 18px;
      height: 18px;
      accent-color: #3b82f6;
    }

    .radio-item label {
      margin: 0;
      font-weight: 400;
      cursor: pointer;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .checkbox-item:hover {
      border-color: #d1d5db;
      background-color: #f9fafb;
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #3b82f6;
      margin-top: 2px;
    }

    .checkbox-item label {
      margin: 0;
      font-weight: 400;
      cursor: pointer;
      flex: 1;
    }

    /* BTG Additional Fields Styling */
    .btg-additional-fields {
      margin-top: 24px;
      padding: 20px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      border-radius: 12px;
      display: none;
    }

    .btg-additional-fields.visible {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .btg-title {
      color: #92400e;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btg-description {
      color: #78350f;
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .consent-section {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      margin: 24px 0;
    }

    .consent-text {
      font-size: 14px;
      line-height: 1.6;
      color: #475569;
      margin-bottom: 20px;
    }

    .consent-checkboxes {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .consent-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .consent-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #3b82f6;
      margin-top: 2px;
    }

    .consent-checkbox label {
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      margin: 0;
    }

    .consent-description {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
      margin-left: 30px;
    }

    .signature-section {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      background: #fafafa;
    }

    .signature-canvas {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      cursor: crosshair;
      width: 100%;
      max-width: 600px;
      height: 200px;
    }

    .signature-instructions {
      margin-bottom: 16px;
      color: #6b7280;
      font-size: 14px;
    }

    .signature-actions {
      margin-top: 16px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-outline {
      background: transparent;
      color: #374151;
      border: 2px solid #e5e7eb;
    }

    .btn-outline:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }

    .button-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 32px;
    }

    .alert {
      padding: 16px;
      border-radius: 8px;
      margin: 20px 0;
      font-size: 14px;
      display: none;
    }

    .alert.success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .alert.error {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .alert.loading {
      background: #f0f9ff;
      color: #0c4a6e;
      border: 1px solid #bae6fd;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(12, 74, 110, 0.3);
      border-radius: 50%;
      border-top-color: #0c4a6e;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .completion-section {
      margin-top: 32px;
      padding: 24px;
      border: 2px solid #10b981;
      border-radius: 12px;
      background: #ecfdf5;
      text-align: center;
      display: none;
    }

    .completion-section h3 {
      color: #065f46;
      margin-bottom: 16px;
    }

    .completion-section p {
      color: #047857;
      margin-bottom: 20px;
    }

    .download-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .info-banner {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border: 1px solid #bfdbfe;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 32px;
    }

    .info-banner h3 {
      color: #1d4ed8;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .info-banner ul {
      color: #1e40af;
      font-size: 14px;
      margin-left: 20px;
    }

    .info-banner li {
      margin-bottom: 6px;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .container {
        margin: 0 16px;
        border-radius: 8px;
      }
      
      .header {
        padding: 24px 20px;
      }
      
      .form-content {
        padding: 24px 20px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }

      .radio-group {
        flex-direction: column;
        gap: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="pageTitle">Quebec Background Check Form</h1>
      <p id="pageSubtitle">Complete your background verification form digitally</p>
      
      <div class="language-toggle">
        <span class="language-label" id="englishLabel">English</span>
        <label class="switch">
          <input type="checkbox" id="languageToggle">
          <span class="slider"></span>
        </label>
        <span class="language-label" id="frenchLabel">Français</span>
      </div>
    </div>

    <div class="form-content">
      <div class="info-banner">
        <h3 id="howItWorksTitle">📋 How It Works</h3>
        <ul id="stepsList">
          <li id="step1">Fill out the form and add your digital signature</li>
          <li id="step2">Upload your government-issued ID photo</li>
          <li id="step3">Generate your completed PDF form</li>
          <li id="step4">Download both files and email them to correctionalfacilities@aa87.org</li>
        </ul>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-number">1</div>
          <h2 class="section-title" id="involvementTitle">Involvement Information</h2>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="sobrietyDate" id="sobrietyDateLabel">Sobriety Date</label>
            <input type="date" id="sobrietyDate">
          </div>
          
          <div class="form-group full-width">
            <label id="involvementLabel">How are you looking to get involved?</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="joinCFC" name="involvement">
                <label for="joinCFC" id="joinCFCLabel">Join the CFC Committee</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="speakFacility" name="involvement">
                <label for="speakFacility" id="speakFacilityLabel">Speak at a Correctional Facility</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="tempContact" name="involvement">
                <label for="tempContact" id="tempContactLabel">Become a Temporary Contact for Bridging the Gap</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="seekingInfo" name="involvement">
                <label for="seekingInfo" id="seekingInfoLabel">Seeking information</label>
              </div>
            </div>

            <!-- BTG Additional Fields Section -->
            <div id="btgAdditionalFields" class="btg-additional-fields">
              <div class="btg-title">
                🌉 <span id="btgSectionTitle">Bridging the Gap - Additional Information</span>
              </div>
              <div class="btg-description" id="btgDescription">
                As a Temporary Contact, you'll help bridge the gap between treatment and recovery by supporting individuals transitioning from correctional facilities back into the community.
              </div>
              
              <div class="form-grid two-column">
                <div class="form-group">
                  <label for="stepsCompleted" id="stepsCompletedLabel">Have you completed your steps? <span class="required">*</span></label>
                  <div class="radio-group">
                    <div class="radio-item">
                      <input type="radio" id="stepsYes" name="stepsCompleted" value="Yes">
                      <label for="stepsYes" id="stepsYesLabel">Yes</label>
                    </div>
                    <div class="radio-item">
                      <input type="radio" id="stepsNo" name="stepsCompleted" value="No">
                      <label for="stepsNo" id="stepsNoLabel">No</label>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label for="travelDistance" id="travelDistanceLabel">Distance outside of your region willing to travel <span class="required">*</span></label>
                  <div class="radio-group">
                    <div class="radio-item">
                      <input type="radio" id="travel5to10" name="travelDistance" value="5-10 km">
                      <label for="travel5to10" id="travel5to10Label">5-10 km</label>
                    </div>
                    <div class="radio-item">
                      <input type="radio" id="travel15to20" name="travelDistance" value="15-20 km">
                      <label for="travel15to20" id="travel15to20Label">15-20 km</label>
                    </div>
                    <div class="radio-item">
                      <input type="radio" id="travel25to30" name="travelDistance" value="25-30 km">
                      <label for="travel25to30" id="travel25to30Label">25-30 km</label>
                    </div>
                    <div class="radio-item">
                      <input type="radio" id="travelNoLimit" name="travelDistance" value="No limit">
                      <label for="travelNoLimit" id="travelNoLimitLabel">No limit</label>
                    </div>
                  </div>
                </div>

                <div class="form-group full-width">
                  <label for="aaRegion" id="aaRegionLabel">Your AA Region <span class="required">*</span></label>
                  <select id="aaRegion" name="aaRegion">
                    <option value="" id="selectRegionOption">Select your region</option>
                    <option value="Area 87: Greater Montreal" id="area87Option">Area 87: Greater Montreal</option>
                    <option value="Area 88: South-East Quebec" id="area88Option">Area 88: South-East Quebec</option>
                    <option value="Area 90: North-Western Quebec" id="area90Option">Area 90: North-Western Quebec</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-number">2</div>
          <h2 class="section-title" id="personalInfoTitle">Personal Information</h2>
        </div>
        
        <div class="form-grid two-column">
          <div class="form-group">
            <label for="prenoms" id="firstNameLabel">First Name <span class="required">*</span></label>
            <input type="text" id="prenoms" maxlength="40" placeholder="First name">
            <div class="char-counter"><span id="prenomsCounter">0</span>/40</div>
          </div>
          
          <div class="form-group">
            <label for="nom" id="lastNameLabel">Last Name <span class="required">*</span></label>
            <input type="text" id="nom" maxlength="40" placeholder="Last name">
            <div class="char-counter"><span id="nomCounter">0</span>/40</div>
          </div>
          
          <div class="form-group">
            <label for="nomNaissance" id="birthNameLabel">Name on birth certificate (if different)</label>
            <input type="text" id="nomNaissance" maxlength="50" placeholder="Birth certificate name">
            <div class="char-counter"><span id="nomNaissanceCounter">0</span>/50</div>
          </div>
          
          <div class="form-group">
            <label for="autreNoms" id="otherNamesLabel">Other names or nicknames</label>
            <input type="text" id="autreNoms" maxlength="60" placeholder="Other names">
            <div class="char-counter"><span id="autreNomsCounter">0</span>/60</div>
          </div>
          
          <div class="form-group">
            <label for="dateNaissance" id="dobLabel">Date of Birth <span class="required">*</span></label>
            <input type="date" id="dateNaissance">
          </div>
          
          <div class="form-group">
            <label id="genderLabel">Gender <span class="required">*</span></label>
            <div class="radio-group">
              <div class="radio-item">
                <input type="radio" id="sexeMasculin" name="sexe" value="Masculin">
                <label for="sexeMasculin" id="maleLabel">Male</label>
              </div>
              <div class="radio-item">
                <input type="radio" id="sexeFeminin" name="sexe" value="Féminin">
                <label for="sexeFeminin" id="femaleLabel">Female</label>
              </div>
            </div>
          </div>
          
          <div class="form-group full-width">
            <label for="nomMere" id="motherNameLabel">Mother's Full Name (First and Last) <span class="required">*</span></label>
            <input type="text" id="nomMere" maxlength="50" placeholder="Mother's full name">
            <div class="char-counter"><span id="nomMereCounter">0</span>/50</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-number">3</div>
          <h2 class="section-title" id="contactTitle">Contact Information</h2>
        </div>
        
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="adresse" id="addressLabel">Address <span class="required">*</span></label>
            <input type="text" id="adresse" maxlength="80" placeholder="Street address">
            <div class="char-counter"><span id="adresseCounter">0</span>/80</div>
          </div>
          
          <div class="form-group">
            <label for="ville" id="cityLabel">City <span class="required">*</span></label>
            <input type="text" id="ville" maxlength="70" placeholder="City">
            <div class="char-counter"><span id="villeCounter">0</span>/70</div>
          </div>
          
          <div class="form-group">
            <label for="postalCode" id="postalCodeLabel">Postal Code <span class="required">*</span></label>
            <input type="text" id="postalCode" maxlength="7" placeholder="A1A 1A1">
          </div>
          
          <div class="form-group">
            <label for="dateAdresse" id="addressDateLabel">Living at this address since</label>
            <input type="date" id="dateAdresse">
          </div>
          
          <div class="form-group">
            <label for="telDomicile" id="homePhoneLabel">Phone Number <span class="required">*</span></label>
            <div class="phone-input-container">
              <input type="tel" id="telDomicile" class="phone-input" maxlength="20" 
                     placeholder="(555) 123-4567" autocomplete="tel-national">
              <span class="phone-validation-icon" id="telDomicileIcon">✓</span>
            </div>
            <div class="phone-format-hint" id="telDomicileHint">Format: (XXX) XXX-XXXX or +1-XXX-XXX-XXXX</div>
            <div class="phone-error-message" id="telDomicileError"></div>
            <div class="char-counter"><span id="telDomicileCounter">0</span>/20</div>
          </div>
          
          <div class="form-group">
            <label for="userEmail" id="emailLabel">Email Address <span class="required">*</span></label>
            <input type="email" id="userEmail" placeholder="your.email@example.com">
          </div>
          
          <div class="form-group">
            <label for="telTravail" id="workPhoneLabel">Work Phone</label>
            <div class="phone-input-container">
              <input type="tel" id="telTravail" class="phone-input" maxlength="20" 
                     placeholder="(555) 123-4567" autocomplete="tel-work">
              <span class="phone-validation-icon" id="telTravailIcon">✓</span>
            </div>
            <div class="phone-format-hint" id="telTravailHint">Format: (XXX) XXX-XXXX or +1-XXX-XXX-XXXX</div>
            <div class="phone-error-message" id="telTravailError"></div>
            <div class="char-counter"><span id="telTravailCounter">0</span>/20</div>
          </div>
          
          <div class="form-group">
            <label for="telAutre" id="otherPhoneLabel">Other Phone Number</label>
            <div class="phone-input-container">
              <input type="tel" id="telAutre" class="phone-input" maxlength="20" 
                     placeholder="(555) 123-4567" autocomplete="tel">
              <span class="phone-validation-icon" id="telAutreIcon">✓</span>
            </div>
            <div class="phone-format-hint" id="telAutreHint">Format: (XXX) XXX-XXXX or +1-XXX-XXX-XXXX</div>
            <div class="phone-error-message" id="telAutreError"></div>
            <div class="char-counter"><span id="telAutreCounter">0</span>/20</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-number">4</div>
          <h2 class="section-title" id="backgroundTitle">Background Information</h2>
        </div>
        
        <div class="form-grid">
          <div class="form-group full-width">
            <label id="crimeLabel">Have you ever been found guilty of a criminal offense in Canada or elsewhere, or are you currently facing prosecution for such an offense? <span class="required">*</span></label>
            <div class="radio-group">
              <div class="radio-item">
                <input type="radio" id="infNon" name="infraction" value="Non">
                <label for="infNon" id="noLabel">No</label>
              </div>
              <div class="radio-item">
                <input type="radio" id="infOui" name="infraction" value="Oui">
                <label for="infOui" id="yesLabel">Yes</label>
              </div>
            </div>
          </div>
          
          <div class="form-group full-width hidden" id="infraDetail">
            <label for="infractionDetails" id="infractionDetailsLabel">If yes, please specify:</label>
            <input type="text" id="infractionDetails" maxlength="150" placeholder="Please provide details">
            <div class="char-counter"><span id="infractionDetailsCounter">0</span>/150</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-number">5</div>
          <h2 class="section-title" id="documentTitle">Photo Upload</h2>
        </div>
        
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="idUpload" id="idUploadLabel">Upload Government-Issued ID Photo <span class="required">*</span></label>
            <input type="file" id="idUpload" accept=".jpg,.jpeg,.png" required>
            <div class="file-upload-hint" id="fileUploadHint">
              Accepted formats: JPG, PNG (Max 5MB) • Driver's license, passport, or government ID
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-number">6</div>
          <h2 class="section-title" id="consentTitle">Consent & Digital Signature</h2>
        </div>
        
        <div class="consent-section">
          <div class="consent-text">
            <p>I, the undersigned, hereby consent to the Directorate General of Correctional Services of the Ministry of Public Security collecting information about my judicial and correctional background. This information will be used solely for the security screening required to authorize my access to individuals, locations, and sensitive information.</p>
            <p>I understand that the verification of my judicial and correctional background by the Directorate General of Correctional Services is a prerequisite for authorizing my access to individuals, locations, and sensitive information. I agree to inform the Directorate General of Correctional Services of any conviction under a law in force in Quebec during my employment contract, internship, or visit.</p>
          </div>
          
          <div class="consent-checkboxes">
            <div class="consent-checkbox">
              <input type="checkbox" id="consentBackground" required>
              <label for="consentBackground" id="consentBackgroundLabel">I consent to a background check</label>
            </div>
            <div class="consent-description" id="consentBackgroundDesc">
              I authorize the organization to conduct a comprehensive background verification for speaking engagements at correctional facilities.
            </div>
            
            <div class="consent-checkbox">
              <input type="checkbox" id="consentData" required>
              <label for="consentData" id="consentDataLabel">I consent to data processing</label>
            </div>
            <div class="consent-description" id="consentDataDesc">
              I understand that my personal information will be processed and stored securely for verification purposes only.
            </div>
          </div>
        </div>
        
        <div class="form-grid two-column">
          <div class="form-group">
            <label for="dateSignature" id="signDateLabel">Signature Date <span class="required">*</span></label>
            <input type="date" id="dateSignature">
          </div>
        </div>
        
        <div class="form-group">
          <label id="digitalSignatureLabel">Digital Signature <span class="required">*</span></label>
          <div class="signature-section">
            <div class="signature-instructions" id="signatureInstructions">
              Use your mouse or finger to sign above / Utilisez votre souris ou votre doigt pour signer ci-dessus
            </div>
            <canvas id="signatureCanvas" class="signature-canvas" width="600" height="200"></canvas>
            <div class="signature-actions">
              <button id="clearSignature" class="btn btn-outline">🗑️ Clear / Effacer</button>
            </div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button type="button" id="generateBtn" class="btn btn-primary">📄 Generate Files & Email Instructions</button>
        <button type="button" id="resetFormBtn" class="btn btn-outline">🔄 Reset Form</button>
      </div>

      <div id="status" class="alert"></div>

      <div id="completionSection" class="completion-section">
        <h3 id="completionTitle">✅ File Ready!</h3>
        <p id="completionInstructions">Download your complete application and email it to <strong>correctionalfacilities@aa87.org</strong></p>
        
        <div class="download-buttons">
          <button id="downloadCompleteBtn" class="btn btn-primary">📥 Download Complete Application</button>
          <button id="emailCompleteBtn" class="btn btn-success">📧 Open Email with Instructions</button>
        </div>
        
        <div style="margin-top: 20px; padding: 16px; background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; text-align: left;">
          <h4 style="color: #1e40af; margin-bottom: 8px;">Email Instructions:</h4>
          <p style="color: #1e40af; margin: 4px 0;"><strong>To:</strong> correctionalfacilities@aa87.org</p>
          <p style="color: #1e40af; margin: 4px 0;"><strong>Subject:</strong> <span id="emailSubject">[Your Name] - Background Check Application</span></p>
          <p style="color: #1e40af; margin: 4px 0;"><strong>Attachment:</strong> Your complete application PDF (includes form + ID photo)</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Enhanced Phone Number Validation System
    class PhoneValidator {
      constructor() {
        this.canadianAreaCodes = [
          '204', '226', '236', '249', '250', '289', '306', '343', '365', '403', '416', '418',
          '431', '437', '438', '450', '506', '514', '519', '548', '579', '581', '587', '604',
          '613', '639', '647', '672', '705', '709', '778', '780', '782', '807', '819', '825',
          '867', '873', '902', '905'
        ];
      }

      cleanPhone(phone) {
        return phone.replace(/\D/g, '');
      }

      formatPhoneInput(phone) {
        const cleaned = this.cleanPhone(phone);
        if (cleaned.length === 0) return '';
        
        if (cleaned.startsWith('1') && cleaned.length > 1) {
          const digits = cleaned.substring(1);
          if (digits.length <= 3) {
            return `+1-${digits}`;
          } else if (digits.length <= 6) {
            return `+1-${digits.substring(0, 3)}-${digits.substring(3)}`;
          } else {
            return `+1-${digits.substring(0, 3)}-${digits.substring(3, 6)}-${digits.substring(6, 10)}`;
          }
        }
        
        if (cleaned.length <= 3) {
          return `(${cleaned}`;
        } else if (cleaned.length <= 6) {
          return `(${cleaned.substring(0, 3)}) ${cleaned.substring(3)}`;
        } else {
          return `(${cleaned.substring(0, 3)}) ${cleaned.substring(3, 6)}-${cleaned.substring(6, 10)}`;
        }
      }

      validatePhone(phone) {
        const cleaned = this.cleanPhone(phone);
        
        if (cleaned.length === 0) {
          return { isValid: true, message: '', type: 'empty' };
        }

        if (cleaned.length === 11 && cleaned.startsWith('1')) {
          const areaCode = cleaned.substring(1, 4);
          const exchange = cleaned.substring(4, 7);
          
          if (!this.canadianAreaCodes.includes(areaCode)) {
            return { isValid: false, message: 'Invalid Canadian area code', type: 'invalid_area_code' };
          }
          
          if (exchange.startsWith('0') || exchange.startsWith('1')) {
            return { isValid: false, message: 'Invalid exchange code', type: 'invalid_exchange' };
          }
          
          return { isValid: true, message: 'Valid Canadian number', type: 'canadian' };
        }
        
        if (cleaned.length === 10) {
          const areaCode = cleaned.substring(0, 3);
          const exchange = cleaned.substring(3, 6);
          
          if (!this.canadianAreaCodes.includes(areaCode)) {
            return { isValid: false, message: 'Invalid Canadian area code', type: 'invalid_area_code' };
          }
          
          if (exchange.startsWith('0') || exchange.startsWith('1')) {
            return { isValid: false, message: 'Invalid exchange code', type: 'invalid_exchange' };
          }
          
          return { isValid: true, message: 'Valid Canadian number', type: 'canadian' };
        }
        
        if (cleaned.length >= 10 && cleaned.length <= 15 && !cleaned.startsWith('1')) {
          return { isValid: true, message: 'Valid international number', type: 'international' };
        }
        
        if (cleaned.length < 10) {
          return { isValid: false, message: 'Phone number too short', type: 'too_short' };
        } else {
          return { isValid: false, message: 'Invalid phone number format', type: 'invalid_format' };
        }
      }

      setupPhoneField(fieldId) {
        const input = document.getElementById(fieldId);
        const icon = document.getElementById(`${fieldId}Icon`);
        const error = document.getElementById(`${fieldId}Error`);
        const counter = document.getElementById(`${fieldId}Counter`);
        
        if (!input) return;

        input.addEventListener('input', (e) => {
          const rawValue = e.target.value;
          const formatted = this.formatPhoneInput(rawValue);
          
          if (formatted !== rawValue) {
            const cursorPos = e.target.selectionStart;
            e.target.value = formatted;
            const newCursorPos = this.calculateCursorPosition(rawValue, formatted, cursorPos);
            e.target.setSelectionRange(newCursorPos, newCursorPos);
          }
          
          const validation = this.validatePhone(formatted);
          this.updateFieldValidation(input, icon, error, counter, validation, formatted);
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const cleaned = this.cleanPhone(paste);
          const formatted = this.formatPhoneInput(cleaned);
          e.target.value = formatted;
          
          const validation = this.validatePhone(formatted);
          this.updateFieldValidation(input, icon, error, counter, validation, formatted);
        });
      }

      calculateCursorPosition(oldValue, newValue, oldPos) {
        const oldCleaned = this.cleanPhone(oldValue.substring(0, oldPos));
        let newPos = 0;
        let cleanedCount = 0;
        
        for (let i = 0; i < newValue.length && cleanedCount < oldCleaned.length; i++) {
          if (/\d/.test(newValue[i])) {
            cleanedCount++;
          }
          newPos = i + 1;
        }
        
        return newPos;
      }

      updateFieldValidation(input, icon, error, counter, validation, value) {
        const cleaned = this.cleanPhone(value);
        
        if (counter) {
          counter.textContent = cleaned.length;
        }
        
        if (validation.type === 'empty') {
          input.classList.remove('valid', 'invalid');
          if (icon) icon.classList.remove('valid', 'invalid');
          if (error) error.style.display = 'none';
        } else if (validation.isValid) {
          input.classList.add('valid');
          input.classList.remove('invalid');
          if (icon) {
            icon.classList.add('valid');
            icon.classList.remove('invalid');
            icon.textContent = '✓';
          }
          if (error) error.style.display = 'none';
        } else {
          input.classList.add('invalid');
          input.classList.remove('valid');
          if (icon) {
            icon.classList.add('invalid');
            icon.classList.remove('valid');
            icon.textContent = '⚠';
          }
          if (error) {
            error.textContent = validation.message;
            error.style.display = 'block';
          }
        }
      }
    }

    // Canadian Postal Code Validator
    class PostalCodeValidator {
      validatePostalCode(postalCode) {
        const cleaned = postalCode.replace(/\s/g, '').toUpperCase();
        const canadianPattern = /^[A-Z]\d[A-Z]\d[A-Z]\d$/;
        return canadianPattern.test(cleaned);
      }

      formatPostalCode(postalCode) {
        const cleaned = postalCode.replace(/\s/g, '').toUpperCase();
        
        if (cleaned.length <= 3) {
          return cleaned;
        } else if (cleaned.length <= 6) {
          return `${cleaned.substring(0, 3)} ${cleaned.substring(3)}`;
        } else {
          return `${cleaned.substring(0, 3)} ${cleaned.substring(3, 6)}`;
        }
      }

      setupPostalCodeField(fieldId) {
        const input = document.getElementById(fieldId);
        if (!input) return;

        input.addEventListener('input', (e) => {
          const formatted = this.formatPostalCode(e.target.value);
          e.target.value = formatted;

          const isValid = this.validatePostalCode(formatted);
          if (isValid) {
            input.classList.add('valid');
            input.classList.remove('invalid');
          } else if (formatted.length > 0) {
            input.classList.add('invalid');
            input.classList.remove('valid');
          } else {
            input.classList.remove('valid', 'invalid');
          }
        });
      }
    }

    // Initialize validators
    const phoneValidator = new PhoneValidator();
    const postalCodeValidator = new PostalCodeValidator();
    
    // Language translations
    const translations = {
      english: {
        pageTitle: "Quebec Background Check Form",
        pageSubtitle: "Complete your background verification form digitally",
        howItWorksTitle: "📋 How It Works",
        step1: "Fill out the form and add your digital signature",
        step2: "Upload your government-issued ID photo",
        step3: "Generate your completed PDF with embedded photo",
        step4: "Download one file and email it to correctionalfacilities@aa87.org",
        involvementTitle: "Involvement Information",
        sobrietyDateLabel: "Sobriety Date",
        involvementLabel: "How are you looking to get involved?",
        joinCFCLabel: "Join the CFC Committee",
        speakFacilityLabel: "Speak at a Correctional Facility",
        tempContactLabel: "Become a Temporary Contact for Bridging the Gap",
        seekingInfoLabel: "Seeking information",
        btgSectionTitle: "Bridging the Gap - Additional Information",
        btgDescription: "As a Temporary Contact, you'll help bridge the gap between treatment and recovery by supporting individuals transitioning from correctional facilities back into the community.",
        stepsCompletedLabel: "Have you completed your steps?",
        stepsYesLabel: "Yes",
        stepsNoLabel: "No",
        travelDistanceLabel: "Distance outside of your region willing to travel",
        travel5to10Label: "5-10 km",
        travel15to20Label: "15-20 km",
        travel25to30Label: "25-30 km",
        travelNoLimitLabel: "No limit",
        aaRegionLabel: "Your AA Region",
        selectRegionOption: "Select your region",
        area87Option: "Area 87: Greater Montreal",
        area88Option: "Area 88: South-East Quebec",
        area90Option: "Area 90: North-Western Quebec",
        personalInfoTitle: "Personal Information",
        firstNameLabel: "First Name",
        lastNameLabel: "Last Name",
        birthNameLabel: "Name on birth certificate (if different)",
        otherNamesLabel: "Other names or nicknames",
        dobLabel: "Date of Birth",
        genderLabel: "Gender",
        maleLabel: "Male",
        femaleLabel: "Female",
        motherNameLabel: "Mother's Full Name (First and Last)",
        contactTitle: "Contact Information",
        addressLabel: "Address",
        cityLabel: "City",
        postalCodeLabel: "Postal Code",
        addressDateLabel: "Living at this address since",
        homePhoneLabel: "Phone Number",
        emailLabel: "Email Address",
        workPhoneLabel: "Work Phone",
        otherPhoneLabel: "Other Phone Number",
        backgroundTitle: "Background Information",
        crimeLabel: "Have you ever been found guilty of a criminal offense in Canada or elsewhere, or are you currently facing prosecution for such an offense?",
        noLabel: "No",
        yesLabel: "Yes",
        infractionDetailsLabel: "If yes, please specify:",
        documentTitle: "Photo Upload",
        idUploadLabel: "Upload Government-Issued ID Photo",
        fileUploadHint: "Accepted formats: JPG, PNG (Max 5MB) • Driver's license, passport, or government ID",
        consentTitle: "Consent & Digital Signature",
        consentBackgroundLabel: "I consent to a background check",
        consentBackgroundDesc: "I authorize the organization to conduct a comprehensive background verification for speaking engagements at correctional facilities.",
        consentDataLabel: "I consent to data processing",
        consentDataDesc: "I understand that my personal information will be processed and stored securely for verification purposes only.",
        signDateLabel: "Signature Date",
        digitalSignatureLabel: "Digital Signature",
        signatureInstructions: "Use your mouse or finger to sign above / Utilisez votre souris ou votre doigt pour signer ci-dessus",
        completionTitle: "✅ File Ready!",
        completionInstructions: "Download your complete application and email it to correctionalfacilities@aa87.org",
        processingMsg: "Generating your form...",
        signatureRequired: "Please sign the form before generating files.",
        photoRequired: "Please upload your ID photo.",
        filesReady: "Files generated successfully!",
        generationError: "Error generating files: "
      },
      french: {
        pageTitle: "Formulaire de vérification d'antécédents du Québec",
        pageSubtitle: "Complétez votre formulaire de vérification des antécédents numériquement",
        howItWorksTitle: "📋 Comment ça marche",
        step1: "Remplissez le formulaire et ajoutez votre signature numérique",
        step2: "Téléchargez votre photo de pièce d'identité gouvernementale",
        step3: "Générez votre formulaire PDF complété",
        step4: "Téléchargez un fichier et envoyez-le par courriel à correctionalfacilities@aa87.org",
        involvementTitle: "Informations sur l'implication",
        sobrietyDateLabel: "Date de sobriété",
        involvementLabel: "Comment souhaitez-vous vous impliquer ?",
        joinCFCLabel: "Rejoindre le comité CFC",
        speakFacilityLabel: "Parler dans un établissement correctionnel",
        tempContactLabel: "Devenir un contact temporaire pour combler l'écart",
        seekingInfoLabel: "Recherche d'informations",
        btgSectionTitle: "Combler l'écart - Informations supplémentaires",
        btgDescription: "En tant que contact temporaire, vous aiderez à combler l'écart entre le traitement et la récupération en soutenant les personnes en transition des établissements correctionnels vers la communauté.",
        stepsCompletedLabel: "Avez-vous complété vos étapes ?",
        stepsYesLabel: "Oui",
        stepsNoLabel: "Non",
        travelDistanceLabel: "Distance à l'extérieur de votre région que vous êtes prêt à parcourir",
        travel5to10Label: "5-10 km",
        travel15to20Label: "15-20 km",
        travel25to30Label: "25-30 km",
        travelNoLimitLabel: "Sans limite",
        aaRegionLabel: "Votre région AA",
        selectRegionOption: "Sélectionnez votre région",
        area87Option: "Zone 87 : Grand Montréal",
        area88Option: "Zone 88 : Sud-Est du Québec",
        area90Option: "Zone 90 : Nord-Ouest du Québec",
        personalInfoTitle: "Informations personnelles",
        firstNameLabel: "Prénom",
        lastNameLabel: "Nom de famille",
        birthNameLabel: "Nom sur l'acte de naissance (si différent)",
        otherNamesLabel: "Autres noms ou surnoms",
        dobLabel: "Date de naissance",
        genderLabel: "Sexe",
        maleLabel: "Masculin",
        femaleLabel: "Féminin",
        motherNameLabel: "Nom complet de la mère (prénom et nom)",
        contactTitle: "Informations de contact",
        addressLabel: "Adresse",
        cityLabel: "Ville",
        postalCodeLabel: "Code postal",
        addressDateLabel: "Habitant à cette adresse depuis",
        homePhoneLabel: "Numéro de téléphone",
        emailLabel: "Adresse courriel",
        workPhoneLabel: "Téléphone travail",
        otherPhoneLabel: "Autre numéro de téléphone",
        backgroundTitle: "Informations sur les antécédents",
        crimeLabel: "Avez-vous déjà été reconnu coupable d'une infraction criminelle au Canada ou ailleurs, ou faites-vous actuellement l'objet de poursuites pour une telle infraction ?",
        noLabel: "Non",
        yesLabel: "Oui",
        infractionDetailsLabel: "Si oui, veuillez préciser :",
        documentTitle: "Téléchargement de photo",
        idUploadLabel: "Télécharger une photo de pièce d'identité gouvernementale",
        fileUploadHint: "Formats acceptés : JPG, PNG (Max 5 Mo) • Permis de conduire, passeport ou pièce d'identité gouvernementale",
        consentTitle: "Consentement et signature numérique",
        consentBackgroundLabel: "Je consens à une vérification des antécédents",
        consentBackgroundDesc: "J'autorise l'organisation à effectuer une vérification complète des antécédents pour les engagements de prise de parole dans les établissements correctionnels.",
        consentDataLabel: "Je consens au traitement des données",
        consentDataDesc: "Je comprends que mes informations personnelles seront traitées et stockées en toute sécurité à des fins de vérification uniquement.",
        signDateLabel: "Date de signature",
        digitalSignatureLabel: "Signature numérique",
        signatureInstructions: "Utilisez votre souris ou votre doigt pour signer ci-dessus / Use your mouse or finger to sign above",
        completionTitle: "✅ Fichier prêt !",
        completionInstructions: "Téléchargez votre candidature complète et envoyez-la par courriel à correctionalfacilities@aa87.org",
        processingMsg: "Génération de votre formulaire...",
        signatureRequired: "Veuillez signer le formulaire avant de générer les fichiers.",
        photoRequired: "Veuillez télécharger votre photo de pièce d'identité.",
        filesReady: "Fichiers générés avec succès !",
        generationError: "Erreur lors de la génération des fichiers : "
      }
    };

    // Variables to store data
    let pdfBytes = null;
    let generatedPdfBytes = null;
    let uploadedPhoto = null;
    let signatureData = null;

    // Function to change language
    function setLanguage(language) {
      const texts = translations[language];
      
      // Update all text elements
      Object.keys(texts).forEach(key => {
        const element = document.getElementById(key);
        if (element) {
          if (element.tagName === 'INPUT' && element.type === 'button') {
            element.value = texts[key];
          } else {
            element.textContent = texts[key];
          }
        }
      });
      
      // Update document language attribute
      document.documentElement.lang = language === 'english' ? 'en' : 'fr';
    }

    // Language toggle event listener
    document.getElementById('languageToggle').addEventListener('change', function() {
      const language = this.checked ? 'french' : 'english';
      setLanguage(language);
    });

    // BTG Additional Fields Toggle
    document.getElementById('tempContact').addEventListener('change', function() {
      const btgFields = document.getElementById('btgAdditionalFields');
      if (this.checked) {
        btgFields.classList.add('visible');
      } else {
        btgFields.classList.remove('visible');
        document.querySelectorAll('input[name="stepsCompleted"]').forEach(radio => radio.checked = false);
        document.querySelectorAll('input[name="travelDistance"]').forEach(radio => radio.checked = false);
        document.getElementById('aaRegion').value = '';
      }
    });

    // Handle infraction details display
    document.querySelectorAll('input[name="infraction"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const infraDetail = document.getElementById('infraDetail');
        if (this.value === 'Oui') {
          infraDetail.classList.remove('hidden');
        } else {
          infraDetail.classList.add('hidden');
        }
      });
    });

    // File upload handling
    document.getElementById('idUpload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          alert('File size must be less than 5MB');
          e.target.value = '';
          return;
        }
        
        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        if (!allowedTypes.includes(file.type)) {
          alert('Please upload a valid image format (JPG, PNG)');
          e.target.value = '';
          return;
        }
        
        uploadedPhoto = file;
        console.log('Photo selected:', file.name, file.size, 'bytes');
      }
    });

    // Initialize signature pad
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    // Setup canvas for drawing
    ctx.lineWidth = 2;
    ctx.strokeStyle = "black";
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Drawing functions
    function startDrawing(e) {
      isDrawing = true;
      draw(e);
    }

    function startDrawingTouch(e) {
      isDrawing = true;
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
      e.preventDefault();
    }

    function draw(e) {
      if (!isDrawing) return;
      
      ctx.lineCap = 'round';
      
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function drawTouch(e) {
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
      e.preventDefault();
    }

    function stopDrawing() {
      if (isDrawing) {
        ctx.beginPath();
        isDrawing = false;
        signatureData = canvas.toDataURL('image/png');
      }
    }

    // Add event listeners for drawing
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    canvas.addEventListener('touchstart', startDrawingTouch);
    canvas.addEventListener('touchmove', drawTouch);
    canvas.addEventListener('touchend', stopDrawing);

    // Clear signature button
    document.getElementById('clearSignature').addEventListener('click', function() {
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      signatureData = null;
    });

    // Auto-load PDF on page load with better error handling
    async function loadPDF() {
      console.log('📄 Attempting to load PDF template...'); // Debug log
      
      try {
        const response = await fetch('./Provincial consent form.pdf');
        console.log('📄 PDF fetch response:', response.status, response.statusText); // Debug log
        
        if (!response.ok) {
          throw new Error(`PDF not found (${response.status}). Make sure "Provincial consent form.pdf" is in the same folder as your HTML file.`);
        }
        
        const arrayBuffer = await response.arrayBuffer();
        pdfBytes = new Uint8Array(arrayBuffer);
        console.log('✅ PDF template loaded successfully, size:', pdfBytes.length, 'bytes'); // Debug log
        
      } catch (error) {
        console.error('❌ Error loading PDF:', error);
        
        // Show user-friendly error
        const errorMsg = 'PDF template not found. Please ensure "Provincial consent form.pdf" is uploaded to your website.';
        showStatus('error', errorMsg);
        
        // Also create a test button to verify the form works without PDF
        const testBtn = document.createElement('button');
        testBtn.textContent = '🧪 Test Without PDF';
        testBtn.className = 'btn btn-secondary';
        testBtn.style.marginLeft = '10px';
        testBtn.onclick = testWithoutPDF;
        document.getElementById('generateBtn').parentNode.appendChild(testBtn);
      }
    }

    // Test function that works without PDF template
    function testWithoutPDF() {
      console.log('🧪 Testing form without PDF template...');
      
      try {
        // Just test the validation and flow
        const applicantName = `${document.getElementById('prenoms').value} ${document.getElementById('nom').value}`;
        
        if (!applicantName.trim() || applicantName === ' ') {
          alert('Please fill in your name to test the form.');
          return;
        }
        
        // Show success message
        showStatus('success', 'Form validation works! (PDF template missing for full functionality)');
        
        // Show what would happen
        alert(`✅ Form test successful!\n\nApplicant: ${applicantName}\nPhoto: ${uploadedPhoto ? 'Uploaded ✅' : 'Missing ❌'}\nSignature: ${signatureData ? 'Signed ✅' : 'Missing ❌'}\n\nTo complete setup, upload "Provincial consent form.pdf" to your website.`);
        
      } catch (error) {
        console.error('Test error:', error);
        alert('Test failed: ' + error.message);
      }
    }

    // Enhanced validation function for BTG fields
    function validateBTGFields() {
      const isBTGSelected = document.getElementById('tempContact').checked;
      if (!isBTGSelected) return { valid: true, missingFields: [] };

      const missingFields = [];

      const stepsCompleted = document.querySelector('input[name="stepsCompleted"]:checked');
      if (!stepsCompleted) {
        missingFields.push('Steps completed');
      }

      const travelDistance = document.querySelector('input[name="travelDistance"]:checked');
      if (!travelDistance) {
        missingFields.push('Travel distance');
      }

      const aaRegion = document.getElementById('aaRegion').value;
      if (!aaRegion) {
        missingFields.push('AA Region');
      }

      return {
        valid: missingFields.length === 0,
        missingFields: missingFields
      };
    }

    // Main generate function with better error handling
    async function generateFilesAndEmail() {
      console.log('🚀 Generate button clicked!'); // Debug log
      
      const language = document.getElementById('languageToggle').checked ? 'french' : 'english';
      const texts = translations[language];

      try {
        showStatus('loading', 'Checking form...');

        // Validate required fields
        const requiredFields = ['prenoms', 'nom', 'dateNaissance', 'nomMere', 'adresse', 'ville', 'postalCode', 'telDomicile', 'userEmail', 'dateSignature'];
        const missingFields = [];
        
        requiredFields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (!field.value.trim()) {
            missingFields.push(field.previousElementSibling.textContent.replace(' *', ''));
          }
        });
        
        // Check gender selection
        const sexe = document.querySelector('input[name="sexe"]:checked');
        if (!sexe) {
          missingFields.push('Gender');
        }
        
        // Check criminal background selection
        const infraction = document.querySelector('input[name="infraction"]:checked');
        if (!infraction) {
          missingFields.push('Criminal background question');
        }

        // Validate BTG fields if selected
        const btgValidation = validateBTGFields();
        if (!btgValidation.valid) {
          missingFields.push(...btgValidation.missingFields);
        }
        
        // Check consent checkboxes
        if (!document.getElementById('consentBackground').checked) {
          missingFields.push('Background check consent');
        }
        if (!document.getElementById('consentData').checked) {
          missingFields.push('Data processing consent');
        }
        
        // Validate signature
        if (!signatureData) {
          missingFields.push('Digital signature');
        }

        // Validate photo upload
        if (!uploadedPhoto) {
          missingFields.push('ID photo upload');
        }
        
        if (missingFields.length > 0) {
          showStatus('error', `Missing required fields: ${missingFields.join(', ')}`);
          alert(`Please complete the following required fields:\n\n• ${missingFields.join('\n• ')}`);
          return;
        }

        console.log('✅ All validation passed'); // Debug log
        showStatus('loading', texts.processingMsg);

        // Generate PDF
        await generatePDF();
        
        console.log('✅ PDF generated successfully'); // Debug log
        
        // Show completion section
        document.getElementById('completionSection').style.display = 'block';
        
        // Update email subject
        const applicantName = `${document.getElementById('prenoms').value} ${document.getElementById('nom').value}`;
        document.getElementById('emailSubject').textContent = `${applicantName} - Background Check Application`;
        
        // Setup download buttons
        setupDownloadButtons();
        
        showStatus('success', texts.filesReady);
        
        // Scroll to completion section
        document.getElementById('completionSection').scrollIntoView({ behavior: 'smooth' });
        
      } catch (error) {
        console.error('❌ Error in generateFilesAndEmail:', error);
        showStatus('error', 'Error: ' + error.message);
        
        // Show detailed error to help debug
        alert(`Error generating files:\n\n${error.message}\n\nCheck browser console (F12) for more details.`);
      }
    }

    // Generate PDF function with embedded photo
    async function generatePDF() {
      // Check if PDF is loaded
      if (!pdfBytes) {
        await loadPDF();
        if (!pdfBytes) {
          throw new Error('PDF template not available');
        }
      }
      
      try {
        const { PDFDocument, StandardFonts } = PDFLib;
        
        // Load the existing PDF
        const pdfDoc = await PDFDocument.load(pdfBytes);
        const pages = pdfDoc.getPages();
        const page = pages[0];
        const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
        
        // Format dates (DD/MM/YYYY)
        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        };
        
        // Get form values
        const nom = document.getElementById('nom').value;
        const prenoms = document.getElementById('prenoms').value;
        const nomNaissance = document.getElementById('nomNaissance').value;
        const autreNoms = document.getElementById('autreNoms').value;
        const dateNaissance = formatDate(document.getElementById('dateNaissance').value);
        const sexeValue = document.querySelector('input[name="sexe"]:checked')?.value || '';
        const nomMere = document.getElementById('nomMere').value;
        const adresse = document.getElementById('adresse').value;
        const ville = document.getElementById('ville').value;
        const postalCode = document.getElementById('postalCode').value;
        const dateAdresse = formatDate(document.getElementById('dateAdresse').value);
        const telDomicile = phoneValidator.cleanPhone(document.getElementById('telDomicile').value);
        const telTravail = phoneValidator.cleanPhone(document.getElementById('telTravail').value);
        const telAutre = phoneValidator.cleanPhone(document.getElementById('telAutre').value);
        const infractionValue = document.querySelector('input[name="infraction"]:checked')?.value || '';
        const infractionDetail = document.getElementById('infractionDetails').value;
        const dateSignature = formatDate(document.getElementById('dateSignature').value);
        
        // Set coordinates for text placement on the PDF
        page.drawText(nom, { x: 170, y: 648, size: 10, font });
        page.drawText(prenoms, { x: 170, y: 700, size: 10, font });
        page.drawText(nomNaissance, { x: 400, y: 680, size: 10, font });
        page.drawText(autreNoms, { x: 400, y: 648, size: 10, font });
        
        // Date of birth
        if (dateNaissance) {
          const [day, month, year] = dateNaissance.split('/');
          page.drawText(day, { x: 50, y: 610, size: 10, font });
          page.drawText(month, { x: 70, y: 610, size: 10, font });
          page.drawText(year, { x: 100, y: 610, size: 10, font });
        }
        
        // Gender
        if (sexeValue === 'Masculin') {
          page.drawText('X', { x: 170, y: 610, size: 12, font });
        } else if (sexeValue === 'Féminin') {
          page.drawText('X', { x: 220, y: 610, size: 12, font });
        }
        
        page.drawText(nomMere, { x: 400, y: 605, size: 10, font });
        page.drawText(`${adresse}, ${ville}, ${postalCode}`, { x: 150, y: 560, size: 10, font });
        
        // Since when at address
        if (dateAdresse) {
          const [day, month, year] = dateAdresse.split('/');
          page.drawText(day, { x: 50, y: 530, size: 10, font });
          page.drawText(month, { x: 70, y: 530, size: 10, font });
          page.drawText(year, { x: 100, y: 530, size: 10, font });
        }
        
        // Phone numbers
        page.drawText(telDomicile, { x: 400, y: 536, size: 10, font });
        page.drawText(telTravail, { x: 390, y: 524, size: 10, font });
        page.drawText(telAutre, { x: 410, y: 516, size: 10, font });
        
        // Criminal history
        if (infractionValue === 'Non') {
          page.drawText('X', { x: 58, y: 455, size: 12, font });
        } else if (infractionValue === 'Oui') {
          page.drawText('X', { x: 88, y: 455, size: 12, font });
          page.drawText(infractionDetail, { x: 110, y: 440, size: 10, font });
        }
        
        // Signature date (for both Parts B and C)
        if (dateSignature) {
          const [day1, month1, year1] = dateSignature.split('/');
          page.drawText(day1, { x: 380, y: 260, size: 10, font });
          page.drawText(month1, { x: 405, y: 260, size: 10, font });
          page.drawText(year1, { x: 435, y: 260, size: 10, font });
          
          page.drawText(day1, { x: 385, y: 180, size: 10, font });
          page.drawText(month1, { x: 410, y: 180, size: 10, font });
          page.drawText(year1, { x: 435, y: 180, size: 10, font });
        }
        
        // Add signature image
        try {
          const signatureImageBytes = await fetch(signatureData).then(res => res.arrayBuffer());
          const signatureImage = await pdfDoc.embedPng(signatureImageBytes);
          const signatureDims = signatureImage.scale(0.2);
          
          page.drawImage(signatureImage, {
            x: 170, y: 250,
            width: signatureDims.width,
            height: signatureDims.height,
          });
          
          page.drawImage(signatureImage, {
            x: 170, y: 170,
            width: signatureDims.width,
            height: signatureDims.height,
          });
        } catch (error) {
          console.error('Error embedding signature:', error);
          throw new Error('Error adding signature to the PDF.');
        }

        // ADD NEW PAGE FOR ID PHOTO
        if (uploadedPhoto) {
          try {
            // Add a new page for the ID photo
            const newPage = pdfDoc.addPage([595, 842]); // Standard A4 size
            
            // Convert uploaded photo to array buffer
            const photoArrayBuffer = await uploadedPhoto.arrayBuffer();
            
            // Embed the photo (support both JPG and PNG)
            let photoImage;
            if (uploadedPhoto.type === 'image/png') {
              photoImage = await pdfDoc.embedPng(photoArrayBuffer);
            } else {
              photoImage = await pdfDoc.embedJpg(photoArrayBuffer);
            }
            
            // Calculate dimensions to fit the photo nicely on the page
            const pageWidth = newPage.getWidth();
            const pageHeight = newPage.getHeight();
            const margin = 50;
            const maxWidth = pageWidth - (margin * 2);
            const maxHeight = pageHeight - (margin * 3) - 60; // Extra space for title
            
            // Scale photo to fit within the page while maintaining aspect ratio
            const { width: photoWidth, height: photoHeight } = photoImage;
            const scaleX = maxWidth / photoWidth;
            const scaleY = maxHeight / photoHeight;
            const scale = Math.min(scaleX, scaleY);
            
            const scaledWidth = photoWidth * scale;
            const scaledHeight = photoHeight * scale;
            
            // Center the photo on the page
            const x = (pageWidth - scaledWidth) / 2;
            const y = (pageHeight - scaledHeight) / 2;
            
            // Add title at the top
            newPage.drawText('Government-Issued ID Document', {
              x: margin,
              y: pageHeight - margin,
              size: 16,
              font: font,
            });
            
            // Add applicant name
            newPage.drawText(`Applicant: ${prenoms} ${nom}`, {
              x: margin,
              y: pageHeight - margin - 25,
              size: 12,
              font: font,
            });
            
            // Draw the photo
            newPage.drawImage(photoImage, {
              x: x,
              y: y,
              width: scaledWidth,
              height: scaledHeight,
            });
            
            // Add photo details at the bottom
            const photoDetails = [
              `File: ${uploadedPhoto.name}`,
              `Size: ${(uploadedPhoto.size / 1024 / 1024).toFixed(2)} MB`,
              `Type: ${uploadedPhoto.type}`,
              `Upload Date: ${new Date().toLocaleDateString()}`
            ];
            
            photoDetails.forEach((detail, index) => {
              newPage.drawText(detail, {
                x: margin,
                y: margin + (photoDetails.length - index - 1) * 15,
                size: 10,
                font: font,
              });
            });
            
          } catch (photoError) {
            console.error('Error embedding photo:', photoError);
            // Continue without photo rather than failing completely
            console.warn('Photo could not be embedded, continuing with form only');
          }
        }
        
        // Save the modified PDF
        const modifiedPdfBytes = await pdfDoc.save();
        generatedPdfBytes = modifiedPdfBytes;
        
      } catch (error) {
        console.error('Error generating PDF:', error);
        throw error;
      }
    }

    // Setup download buttons
    function setupDownloadButtons() {
      const applicantName = `${document.getElementById('prenoms').value}_${document.getElementById('nom').value}`;
      
      // Download complete PDF button (form + photo)
      document.getElementById('downloadCompleteBtn').onclick = function() {
        if (generatedPdfBytes) {
          download(generatedPdfBytes, `${applicantName}_complete_application.pdf`, 'application/pdf');
        }
      };
      
      // Email button
      document.getElementById('emailCompleteBtn').onclick = function() {
        openEmailWithInstructions();
      };
    }

    // Open email with instructions
    function openEmailWithInstructions() {
      const applicantName = `${document.getElementById('prenoms').value} ${document.getElementById('nom').value}`;
      const userEmail = document.getElementById('userEmail').value;
      const submissionDate = new Date().toLocaleDateString();
      
      const subject = encodeURIComponent(`${applicantName} - Background Check Application`);
      const body = encodeURIComponent(`Hello,

I am submitting my Quebec Background Check Form for volunteer screening.

Applicant: ${applicantName}
Email: ${userEmail}
Date: ${submissionDate}

Please find attached my complete application, which includes:
- Completed Background Check Form
- Government-issued ID photo

Thank you for your consideration.

Best regards,
${applicantName}`);
      
      const mailtoLink = `mailto:correctionalfacilities@aa87.org?subject=${subject}&body=${body}`;
      
      try {
        window.location.href = mailtoLink;
        
        // Show additional instructions after attempting to open email
        setTimeout(() => {
          alert('📧 Email opened!\n\nRemember to:\n✅ Attach your complete application PDF\n✅ Send the email\n\nEverything is included in one file!');
        }, 1000);
        
      } catch (error) {
        console.error('Email open failed:', error);
        alert('Could not open email client automatically.\n\nPlease manually email the complete application PDF to:\ncorrectionalfacilities@aa87.org');
      }
    }

    // Reset form button
    document.getElementById('resetFormBtn').addEventListener('click', function() {
      if (confirm('Are you sure you want to reset the entire form? This will clear all your data.')) {
        // Reset all form fields
        document.querySelectorAll('input[type="text"], input[type="tel"], input[type="date"], input[type="email"], input[type="file"]').forEach(input => {
          input.value = '';
          input.classList.remove('valid', 'invalid');
        });
        
        document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
          input.checked = false;
        });

        document.querySelectorAll('select').forEach(select => {
          select.value = '';
        });
        
        // Reset validation UI
        document.querySelectorAll('.phone-validation-icon').forEach(icon => {
          icon.classList.remove('valid', 'invalid');
        });
        
        document.querySelectorAll('.phone-error-message').forEach(error => {
          error.style.display = 'none';
        });
        
        // Hide conditional fields
        document.getElementById('infraDetail').classList.add('hidden');
        document.getElementById('btgAdditionalFields').classList.remove('visible');
        
        // Clear signature
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        signatureData = null;
        
        // Clear uploaded photo
        uploadedPhoto = null;
        
        // Hide completion section
        document.getElementById('completionSection').style.display = 'none';
        
        // Clear status
        document.getElementById('status').style.display = 'none';
        
        // Reset generated data
        generatedPdfBytes = null;
        
        // Reset signature date to today
        document.getElementById('dateSignature').value = new Date().toISOString().split('T')[0];
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });

    // Helper function to show status messages
    function showStatus(type, message) {
      const statusElement = document.getElementById('status');
      statusElement.className = `alert ${type}`;
      statusElement.style.display = 'block';
      
      if (type === 'loading') {
        statusElement.innerHTML = `<div class="spinner"></div> ${message}`;
      } else {
        statusElement.textContent = message;
      }
      
      if (type !== 'loading') {
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 5000);
      }
    }

    // Character counter functionality
    const textInputs = [
      { id: 'nom', maxLength: 40 },
      { id: 'prenoms', maxLength: 40 },
      { id: 'nomNaissance', maxLength: 50 },
      { id: 'autreNoms', maxLength: 60 },
      { id: 'nomMere', maxLength: 50 },
      { id: 'adresse', maxLength: 80 },
      { id: 'ville', maxLength: 70 },
      { id: 'infractionDetails', maxLength: 150 }
    ];

    textInputs.forEach(input => {
      const inputElement = document.getElementById(input.id);
      const counterElement = document.getElementById(`${input.id}Counter`);
      
      if (inputElement && counterElement) {
        counterElement.textContent = inputElement.value.length;
        
        inputElement.addEventListener('input', function() {
          counterElement.textContent = this.value.length;
          
          const charCount = this.value.length;
          const percent = charCount / input.maxLength;
          
          if (percent >= 0.9) {
            counterElement.style.color = '#ef4444';
          } else if (percent >= 0.7) {
            counterElement.style.color = '#f59e0b';
          } else {
            counterElement.style.color = '#6b7280';
          }
        });
      }
    });

    // Initialize everything
    document.addEventListener('DOMContentLoaded', function() {
      // Setup validators
      phoneValidator.setupPhoneField('telDomicile');
      phoneValidator.setupPhoneField('telTravail');
      phoneValidator.setupPhoneField('telAutre');
      postalCodeValidator.setupPostalCodeField('postalCode');
      
      // Set today's date as default signature date
      document.getElementById('dateSignature').value = new Date().toISOString().split('T')[0];
      
      // Attach event listeners
      document.getElementById('generateBtn').addEventListener('click', generateFilesAndEmail);
      
      // Initialize language and load PDF
      setLanguage('english');
      loadPDF();
    });
  </script>
</body>
</html>
