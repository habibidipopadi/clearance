<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quebec Background Check Form Filler</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .char-counter {
      color: #6c757d;
      font-size: 12px;
      display: block;
      text-align: right;
      margin-top: 2px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .form-section {
      background-color: #f9f9f9;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input[type="text"], 
    input[type="date"],
    input[type="tel"],
    input[type="email"],
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .radio-group {
      display: flex;
      gap: 15px;
    }
    .radio-group label {
      font-weight: normal;
    }
    .btn {
      background-color: #0056b3;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
    }
    .btn:hover {
      background-color: #003d7e;
    }
    .btn-secondary {
      background-color: #6c757d;
    }
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    .btn-success {
      background-color: #28a745;
    }
    .btn-success:hover {
      background-color: #218838;
    }
    #status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .loading {
      background-color: #e2e3e5;
      color: #383d41;
      border: 1px solid #d6d8db;
    }
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.3);
      border-radius: 50%;
      border-top-color: #0056b3;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .pdf-container {
      margin-top: 20px;
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      display: none;
    }
    .pdf-preview {
      width: 100%;
      height: 800px;
      border: none;
    }
    #signatureCanvas {
      border: 1px solid #ddd;
      background-color: #fff;
      cursor: crosshair;
    }
    .signature-pad {
      margin-top: 10px;
    }
    .signature-actions {
      margin-top: 10px;
    }
    .note {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
      color: #856404;
    }
    
    /* Language toggle switch styles */
    .language-toggle-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }
    .language-label {
      font-weight: bold;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2196F3;
    }
    input:focus + .slider {
      box-shadow: 0 0 1px #2196F3;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    /* Added custom styles for consent text */
    .consent-text {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #0056b3;
      font-size: 0.95em;
      line-height: 1.5;
    }
    .consent-text p {
      margin-bottom: 10px;
    }
    
    /* Email section styles */
    .email-section {
      border: 2px solid #28a745;
      background-color: #f8fff9;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .email-note {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
      color: #0c5460;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1 id="pageTitle">Quebec Background Check Form Filler</h1>
  
  <!-- Language Toggle -->
  <div class="language-toggle-container">
    <span class="language-label" id="englishLabel">English</span>
    <label class="switch">
      <input type="checkbox" id="languageToggle">
      <span class="slider"></span>
    </label>
    <span class="language-label" id="frenchLabel">FranÃ§ais</span>
  </div>
  
  <div class="note" id="noteContent">
    <p><strong id="noteLabel">Note:</strong> <span id="noteText">Fill out the form below and your completed PDF will be automatically generated using the official Quebec Background Check Form.</span></p>
  </div>

  <div class="form-section">
    <h2 id="personalInfoTitle">Personal Information</h2>
    <div class="form-group">
      <label for="nom" id="lastNameLabel">Last Name:</label>
      <input type="text" id="nom" maxlength="40">
      <small class="char-counter"><span id="nomCounter">0</span>/40</small>
    </div>
    <div class="form-group">
      <label for="prenoms" id="firstNameLabel">First Name:</label>
      <input type="text" id="prenoms" maxlength="40">
      <small class="char-counter"><span id="prenomsCounter">0</span>/40</small>
    </div>
    <div class="form-group">
      <label for="nomNaissance" id="birthNameLabel">Name on birth certificate (if different):</label>
      <input type="text" id="nomNaissance" maxlength="50">
      <small class="char-counter"><span id="nomNaissanceCounter">0</span>/50</small>
    </div>
    <div class="form-group">
      <label for="autreNoms" id="otherNamesLabel">Any other names, first names or nicknames:</label>
      <input type="text" id="autreNoms" maxlength="60">
      <small class="char-counter"><span id="autreNomsCounter">0</span>/60</small>
    </div>
    <div class="form-group">
      <label for="dateNaissance" id="dobLabel">Date of Birth (DD/MM/YYYY):</label>
      <input type="date" id="dateNaissance">
    </div>
    <div class="form-group">
      <label id="genderLabel">Gender:</label>
      <div class="radio-group">
        <div>
          <input type="radio" id="sexeMasculin" name="sexe" value="Masculin">
          <label for="sexeMasculin" id="maleLabel">Male</label>
        </div>
        <div>
          <input type="radio" id="sexeFeminin" name="sexe" value="FÃ©minin">
          <label for="sexeFeminin" id="femaleLabel">Female</label>
        </div>
      </div>
    </div>
    <div class="form-group">
      <label for="nomMere" id="motherNameLabel">Mother's Full Name (First and Last):</label>
      <input type="text" id="nomMere" maxlength="50">
      <small class="char-counter"><span id="nomMereCounter">0</span>/50</small>
    </div>
    <div class="form-group">
      <label for="adresse" id="addressLabel">Address - Number, Street, Apartment:</label>
      <input type="text" id="adresse" maxlength="80">
      <small class="char-counter"><span id="adresseCounter">0</span>/80</small>
    </div>
    <div class="form-group">
      <label for="ville" id="cityLabel">City, Province, Postal Code:</label>
      <input type="text" id="ville" maxlength="70">
      <small class="char-counter"><span id="villeCounter">0</span>/70</small>
    </div>
    <div class="form-group">
      <label for="dateAdresse" id="addressDateLabel">Since when have you lived at this address (DD/MM/YYYY):</label>
      <input type="date" id="dateAdresse">
    </div>
    <div class="form-group">
      <label for="telDomicile" id="homePhoneLabel">Home Phone:</label>
      <input type="tel" id="telDomicile" maxlength="20" inputmode="numeric" pattern="[0-9]*">
      <small class="char-counter"><span id="telDomicileCounter">0</span>/20</small>
    </div>
    <div class="form-group">
      <label for="telTravail" id="workPhoneLabel">Work Phone:</label>
      <input type="tel" id="telTravail" maxlength="20" inputmode="numeric" pattern="[0-9]*">
      <small class="char-counter"><span id="telTravailCounter">0</span>/20</small>
    </div>
    <div class="form-group">
      <label for="telAutre" id="otherPhoneLabel">Other Phone Number:</label>
      <input type="tel" id="telAutre" maxlength="20" inputmode="numeric" pattern="[0-9]*">
      <small class="char-counter"><span id="telAutreCounter">0</span>/20</small>
    </div>
    <div class="form-group">
      <label id="crimeLabel">Have you ever been found guilty of a criminal offense in Canada or elsewhere, or are you currently facing prosecution for such an offense?</label>
      <div class="radio-group">
        <div>
          <input type="radio" id="infNon" name="infraction" value="Non">
          <label for="infNon" id="noLabel">No</label>
        </div>
        <div>
          <input type="radio" id="infOui" name="infraction" value="Oui">
          <label for="infOui" id="yesLabel">Yes</label>
        </div>
      </div>
    </div>
    <div class="form-group" id="infraDetail" style="display:none;">
      <label for="infractionDetails" id="infractionDetailsLabel">If yes, please specify:</label>
      <input type="text" id="infractionDetails" maxlength="150">
      <small class="char-counter"><span id="infractionDetailsCounter">0</span>/150</small>
    </div>
  </div>

  <div class="form-section">
    <h2 id="signatureTitle">Digital Signature</h2>
    
    <!-- Added consent text -->
    <div class="form-group">
      <div class="consent-text">
        <p>I, the undersigned, hereby consent to the Directorate General of Correctional Services of the Ministry of Public Security collecting information about my judicial and correctional background. This information will be used solely for the security screening required to authorize my access to individuals, locations, and sensitive information. I have been informed that only persons duly authorized by the Directorate General of Correctional Services have access to this information.</p>
        <p>I, the undersigned, understand that the verification of my judicial and correctional background by the Directorate General of Correctional Services is a prerequisite for authorizing my access to individuals, locations, and sensitive information. In addition, I agree to inform the Directorate General of Correctional Services of any conviction under a law in force in Quebec during my employment contract, internship, or visit.</p>
      </div>
    </div>
    
    <div class="form-group">
      <label for="dateSignature" id="signDateLabel">Signature Date (DD/MM/YYYY):</label>
      <input type="date" id="dateSignature">
    </div>
    <div class="form-group">
      <label id="yourSignatureLabel">Your Signature:</label>
      <div class="signature-pad">
        <canvas id="signatureCanvas" width="600" height="150"></canvas>
        <div class="signature-actions">
          <button id="clearSignature" class="btn btn-secondary">Clear Signature</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Submission Section -->
  <div class="form-section email-section">
    <h2 id="emailTitle">ðŸ“§ Email Submission (Optional)</h2>
    <div class="email-note">
      <p id="emailNote"><strong>Optional:</strong> Enter your email address to automatically send the completed PDF form to xcorelegacy@gmail.com and receive a copy yourself.</p>
    </div>
    <div class="form-group">
      <label for="userEmail" id="emailLabel">Your Email Address:</label>
      <input type="email" id="userEmail" placeholder="your.email@example.com">
    </div>
    <div class="form-group">
      <label for="phoneNumber" id="phoneLabel">Your Phone Number (optional):</label>
      <input type="tel" id="phoneNumber" placeholder="(123) 456-7890">
    </div>
  </div>

  <div class="button-group">
    <button type="button" id="fillPdfBtn" class="btn">Generate Completed Form</button>
    <button type="button" id="resetFormBtn" class="btn btn-secondary">Reset Form</button>
  </div>

  <div id="status"></div>

  <div id="pdfContainer" class="pdf-container">
    <h3 id="completedFormTitle">Your completed form is ready!</h3>
    <p id="downloadInstructions">Download your PDF and optionally email it directly.</p>
    <div class="button-group">
      <button id="downloadPdfBtn" class="btn">Download PDF</button>
      <button id="printPdfBtn" class="btn btn-secondary">Print PDF</button>
      <button id="emailPdfBtn" class="btn btn-success">ðŸ“§ Email PDF with Attachment</button>
    </div>
    <div style="margin-top: 20px;">
      <iframe id="pdfPreview" class="pdf-preview"></iframe>
    </div>
  </div>

  <script>
    // Web3Forms Configuration
    const WEB3FORMS_ACCESS_KEY = '1ddb8397-e685-4460-8d42-15905ba37311';

    // Language translations
    const translations = {
      english: {
        pageTitle: "Quebec Background Check Form Filler",
        noteLabel: "Note:",
        noteText: "Fill out the form below and your completed PDF will be automatically generated using the official Quebec Background Check Form.",
        personalInfoTitle: "Personal Information",
        lastNameLabel: "Last Name:",
        firstNameLabel: "First Name:",
        birthNameLabel: "Name on birth certificate (if different):",
        otherNamesLabel: "Any other names, first names or nicknames:",
        dobLabel: "Date of Birth (DD/MM/YYYY):",
        genderLabel: "Gender:",
        maleLabel: "Male",
        femaleLabel: "Female",
        motherNameLabel: "Mother's Full Name (First and Last):",
        addressLabel: "Address - Number, Street, Apartment:",
        cityLabel: "City, Province, Postal Code:",
        addressDateLabel: "Since when have you lived at this address (DD/MM/YYYY):",
        homePhoneLabel: "Home Phone:",
        workPhoneLabel: "Work Phone:",
        otherPhoneLabel: "Other Phone Number:",
        crimeLabel: "Have you ever been found guilty of a criminal offense in Canada or elsewhere, or are you currently facing prosecution for such an offense?",
        noLabel: "No",
        yesLabel: "Yes",
        infractionDetailsLabel: "If yes, please specify:",
        signatureTitle: "Digital Signature",
        signDateLabel: "Signature Date (DD/MM/YYYY):",
        yourSignatureLabel: "Your Signature:",
        clearSignature: "Clear Signature",
        emailTitle: "ðŸ“§ Email Submission (Optional)",
        emailNote: "Optional: Enter your email address to automatically send the completed PDF form to xcorelegacy@gmail.com and receive a copy yourself.",
        emailLabel: "Your Email Address:",
        phoneLabel: "Your Phone Number (optional):",
        fillPdfBtn: "Generate Completed Form",
        resetFormBtn: "Reset Form",
        completedFormTitle: "Your completed form is ready!",
        downloadInstructions: "Download your PDF and optionally email it directly.",
        downloadPdfBtn: "Download PDF",
        printPdfBtn: "Print PDF",
        emailPdfBtn: "ðŸ“§ Email PDF with Attachment",
        // Status messages
        processingMsg: "Generating your form... Please wait.",
        emailSendingMsg: "Sending email with PDF attachment... Please wait.",
        signatureRequired: "Please sign the form before generating the PDF.",
        emailRequired: "Please enter your email address to send the PDF.",
        pdfLoadError: "Error loading the PDF template. Please try again.",
        signatureError: "Error adding signature to the PDF.",
        pdfSuccess: "PDF form has been successfully generated!",
        emailSuccess: "Email sent successfully! Check your inbox and xcorelegacy@gmail.com has been notified.",
        emailError: "Error sending email: ",
        pdfError: "Error processing the PDF: "
      },
      french: {
        pageTitle: "Formulaire de vÃ©rification d'antÃ©cÃ©dents du QuÃ©bec",
        noteLabel: "Remarque :",
        noteText: "Remplissez le formulaire ci-dessous et votre PDF complÃ©tÃ© sera automatiquement gÃ©nÃ©rÃ© en utilisant le formulaire officiel de vÃ©rification des antÃ©cÃ©dents du QuÃ©bec.",
        personalInfoTitle: "Informations personnelles",
        lastNameLabel: "Nom de famille :",
        firstNameLabel: "PrÃ©nom :",
        birthNameLabel: "Nom sur l'acte de naissance (si diffÃ©rent) :",
        otherNamesLabel: "Autres noms, prÃ©noms ou surnoms :",
        dobLabel: "Date de naissance (JJ/MM/AAAA) :",
        genderLabel: "Sexe :",
        maleLabel: "Masculin",
        femaleLabel: "FÃ©minin",
        motherNameLabel: "Nom complet de la mÃ¨re (prÃ©nom et nom) :",
        addressLabel: "Adresse - NumÃ©ro, rue, appartement :",
        cityLabel: "Ville, province, code postal :",
        addressDateLabel: "Depuis quand habitez-vous Ã  cette adresse (JJ/MM/AAAA) :",
        homePhoneLabel: "TÃ©lÃ©phone domicile :",
        workPhoneLabel: "TÃ©lÃ©phone travail :",
        otherPhoneLabel: "Autre numÃ©ro de tÃ©lÃ©phone :",
        crimeLabel: "Avez-vous dÃ©jÃ  Ã©tÃ© reconnu coupable d'une infraction criminelle au Canada ou ailleurs, ou faites-vous actuellement l'objet de poursuites pour une telle infraction ?",
        noLabel: "Non",
        yesLabel: "Oui",
        infractionDetailsLabel: "Si oui, veuillez prÃ©ciser :",
        signatureTitle: "Signature numÃ©rique",
        signDateLabel: "Date de signature (JJ/MM/AAAA) :",
        yourSignatureLabel: "Votre signature :",
        clearSignature: "Effacer la signature",
        emailTitle: "ðŸ“§ Soumission par courriel (optionnel)",
        emailNote: "Optionnel : Entrez votre adresse courriel pour envoyer automatiquement le formulaire PDF complÃ©tÃ© Ã  xcorelegacy@gmail.com et recevoir une copie.",
        emailLabel: "Votre adresse courriel :",
        phoneLabel: "Votre numÃ©ro de tÃ©lÃ©phone (optionnel) :",
        fillPdfBtn: "GÃ©nÃ©rer le formulaire complÃ©tÃ©",
        resetFormBtn: "RÃ©initialiser le formulaire",
        completedFormTitle: "Votre formulaire complÃ©tÃ© est prÃªt !",
        downloadInstructions: "TÃ©lÃ©chargez votre PDF et envoyez-le optionnellement par courriel directement.",
        downloadPdfBtn: "TÃ©lÃ©charger le PDF",
        printPdfBtn: "Imprimer le PDF",
        emailPdfBtn: "ðŸ“§ Envoyer PDF par courriel avec piÃ¨ce jointe",
        // Status messages
        processingMsg: "GÃ©nÃ©ration de votre formulaire... Veuillez patienter.",
        emailSendingMsg: "Envoi du courriel avec piÃ¨ce jointe PDF... Veuillez patienter.",
        signatureRequired: "Veuillez signer le formulaire avant de gÃ©nÃ©rer le PDF.",
        emailRequired: "Veuillez entrer votre adresse courriel pour envoyer le PDF.",
        pdfLoadError: "Erreur lors du chargement du modÃ¨le PDF. Veuillez rÃ©essayer.",
        signatureError: "Erreur lors de l'ajout de la signature au PDF.",
        pdfSuccess: "Le formulaire PDF a Ã©tÃ© gÃ©nÃ©rÃ© avec succÃ¨s !",
        emailSuccess: "Courriel envoyÃ© avec succÃ¨s ! VÃ©rifiez votre boÃ®te de rÃ©ception et xcorelegacy@gmail.com a Ã©tÃ© notifiÃ©.",
        emailError: "Erreur lors de l'envoi du courriel : ",
        pdfError: "Erreur lors du traitement du PDF : "
      }
    };

    // Variables to store PDF data
    let pdfBytes = null;
    let generatedPdfBytes = null;

    // Function to change language
    function setLanguage(language) {
      const texts = translations[language];
      
      // Update all text elements
      document.getElementById('pageTitle').textContent = texts.pageTitle;
      document.getElementById('noteLabel').textContent = texts.noteLabel;
      document.getElementById('noteText').textContent = texts.noteText;
      document.getElementById('personalInfoTitle').textContent = texts.personalInfoTitle;
      document.getElementById('lastNameLabel').textContent = texts.lastNameLabel;
      document.getElementById('firstNameLabel').textContent = texts.firstNameLabel;
      document.getElementById('birthNameLabel').textContent = texts.birthNameLabel;
      document.getElementById('otherNamesLabel').textContent = texts.otherNamesLabel;
      document.getElementById('dobLabel').textContent = texts.dobLabel;
      document.getElementById('genderLabel').textContent = texts.genderLabel;
      document.getElementById('maleLabel').textContent = texts.maleLabel;
      document.getElementById('femaleLabel').textContent = texts.femaleLabel;
      document.getElementById('motherNameLabel').textContent = texts.motherNameLabel;
      document.getElementById('addressLabel').textContent = texts.addressLabel;
      document.getElementById('cityLabel').textContent = texts.cityLabel;
      document.getElementById('addressDateLabel').textContent = texts.addressDateLabel;
      document.getElementById('homePhoneLabel').textContent = texts.homePhoneLabel;
      document.getElementById('workPhoneLabel').textContent = texts.workPhoneLabel;
      document.getElementById('otherPhoneLabel').textContent = texts.otherPhoneLabel;
      document.getElementById('crimeLabel').textContent = texts.crimeLabel;
      document.getElementById('noLabel').textContent = texts.noLabel;
      document.getElementById('yesLabel').textContent = texts.yesLabel;
      document.getElementById('infractionDetailsLabel').textContent = texts.infractionDetailsLabel;
      document.getElementById('signatureTitle').textContent = texts.signatureTitle;
      document.getElementById('signDateLabel').textContent = texts.signDateLabel;
      document.getElementById('yourSignatureLabel').textContent = texts.yourSignatureLabel;
      document.getElementById('clearSignature').textContent = texts.clearSignature;
      document.getElementById('emailTitle').textContent = texts.emailTitle;
      document.getElementById('emailNote').textContent = texts.emailNote;
      document.getElementById('emailLabel').textContent = texts.emailLabel;
      document.getElementById('phoneLabel').textContent = texts.phoneLabel;
      document.getElementById('fillPdfBtn').textContent = texts.fillPdfBtn;
      document.getElementById('resetFormBtn').textContent = texts.resetFormBtn;
      document.getElementById('completedFormTitle').textContent = texts.completedFormTitle;
      document.getElementById('downloadInstructions').textContent = texts.downloadInstructions;
      document.getElementById('downloadPdfBtn').textContent = texts.downloadPdfBtn;
      document.getElementById('printPdfBtn').textContent = texts.printPdfBtn;
      document.getElementById('emailPdfBtn').textContent = texts.emailPdfBtn;
      
      // Update document language attribute
      document.documentElement.lang = language === 'english' ? 'en' : 'fr';
    }

    // Language toggle event listener
    document.getElementById('languageToggle').addEventListener('change', function() {
      const language = this.checked ? 'french' : 'english';
      setLanguage(language);
    });

    // Handle infraction details display
    document.querySelectorAll('input[name="infraction"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const infraDetail = document.getElementById('infraDetail');
        if (this.value === 'Oui') {
          infraDetail.style.display = 'block';
        } else {
          infraDetail.style.display = 'none';
        }
      });
    });

    // Initialize signature pad
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let signatureData = null;

    // Setup canvas for drawing
    ctx.lineWidth = 2;
    ctx.strokeStyle = "black";
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Add event listeners for drawing
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events for mobile
    canvas.addEventListener('touchstart', startDrawingTouch);
    canvas.addEventListener('touchmove', drawTouch);
    canvas.addEventListener('touchend', stopDrawing);

    // Drawing functions
    function startDrawing(e) {
      isDrawing = true;
      draw(e);
    }

    function startDrawingTouch(e) {
      isDrawing = true;
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
      e.preventDefault();
    }

    function draw(e) {
      if (!isDrawing) return;
      
      ctx.lineCap = 'round';
      
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function drawTouch(e) {
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
      e.preventDefault();
    }

    function stopDrawing() {
      if (isDrawing) {
        ctx.beginPath();
        isDrawing = false;
        // Save signature data
        signatureData = canvas.toDataURL('image/png');
      }
    }

    // Clear signature button
    document.getElementById('clearSignature').addEventListener('click', function() {
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      signatureData = null;
    });

    // Reset form button
    document.getElementById('resetFormBtn').addEventListener('click', function() {
      // Reset all form fields
      document.querySelectorAll('input[type="text"], input[type="tel"], input[type="date"], input[type="email"]').forEach(input => {
        input.value = '';
      });
      
      document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
        input.checked = false;
      });
      
      // Hide conditional fields
      document.getElementById('infraDetail').style.display = 'none';
      
      // Clear signature
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      signatureData = null;
      
      // Hide PDF container
      document.getElementById('pdfContainer').style.display = 'none';
      
      // Clear status
      document.getElementById('status').style.display = 'none';
      
      // Reset generated PDF
      generatedPdfBytes = null;
    });

    // Auto-load PDF on page load
    async function loadPDF() {
      try {
        // Load the PDF from the same directory
        const response = await fetch('./Provincial consent form.pdf');
        if (!response.ok) {
          throw new Error('PDF not found');
        }
        const arrayBuffer = await response.arrayBuffer();
        pdfBytes = new Uint8Array(arrayBuffer);
        console.log('PDF template loaded successfully');
      } catch (error) {
        console.error('Error loading PDF:', error);
        const language = document.getElementById('languageToggle').checked ? 'french' : 'english';
        showStatus('error', translations[language].pdfLoadError);
      }
    }

    // Fill PDF function
    async function fillPDF() {
      const language = document.getElementById('languageToggle').checked ? 'french' : 'english';
      const texts = translations[language];
      
      // Validate signature
      if (!signatureData) {
        alert(texts.signatureRequired);
        return;
      }
      
      // Check if PDF is loaded
      if (!pdfBytes) {
        await loadPDF();
        if (!pdfBytes) {
          return;
        }
      }
      
      showStatus('loading', texts.processingMsg);
      
      try {
        const { PDFDocument, rgb, StandardFonts } = PDFLib;
        
        // Load the existing PDF
        const pdfDoc = await PDFDocument.load(pdfBytes);
        
        // Get the first page of the document
        const pages = pdfDoc.getPages();
        const page = pages[0];
        
        // Get a font
        const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
        
        // Format dates (DD/MM/YYYY)
        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        };
        
        // Get form values
        const nom = document.getElementById('nom').value;
        const prenoms = document.getElementById('prenoms').value;
        const nomNaissance = document.getElementById('nomNaissance').value;
        const autreNoms = document.getElementById('autreNoms').value;
        const dateNaissance = formatDate(document.getElementById('dateNaissance').value);
        
        const sexe = document.querySelector('input[name="sexe"]:checked');
        const sexeValue = sexe ? sexe.value : '';
        
        const nomMere = document.getElementById('nomMere').value;
        const adresse = document.getElementById('adresse').value;
        const ville = document.getElementById('ville').value;
        const dateAdresse = formatDate(document.getElementById('dateAdresse').value);
        const telDomicile = document.getElementById('telDomicile').value;
        const telTravail = document.getElementById('telTravail').value;
        const telAutre = document.getElementById('telAutre').value;
        
        const infraction = document.querySelector('input[name="infraction"]:checked');
        const infractionValue = infraction ? infraction.value : '';
        const infractionDetail = document.getElementById('infractionDetails').value;
        
        const dateSignature = formatDate(document.getElementById('dateSignature').value);
        
        // Set coordinates for text placement on the PDF
        // Section 2 - Personal Information
        // Last name
        page.drawText(nom, { x: 170, y: 648, size: 10, font });
        
        // First names
        page.drawText(prenoms, { x: 170, y: 700, size: 10, font });
        
        // Birth name
        page.drawText(nomNaissance, { x: 400, y: 680, size: 10, font });
        
        // Other names
        page.drawText(autreNoms, { x: 400, y: 648, size: 10, font });
        
        // Date of birth
        if (dateNaissance) {
          const [day, month, year] = dateNaissance.split('/');
          page.drawText(day, { x: 50, y: 610, size: 10, font });
          page.drawText(month, { x: 70, y: 610, size: 10, font });
          page.drawText(year, { x: 100, y: 610, size: 10, font });
        }
        
        // Gender
        if (sexeValue === 'Masculin') {
          page.drawText('X', { x: 170, y: 610, size: 12, font });
        } else if (sexeValue === 'FÃ©minin') {
          page.drawText('X', { x: 220, y: 610, size: 12, font });
        }
        
        // Mother's name
        page.drawText(nomMere, { x: 400, y: 605, size: 10, font });
        
        // Address
        page.drawText(adresse, { x: 150, y: 560, size: 10, font });
        
        // City, province, postal code
        page.drawText(ville, { x: 400, y: 580, size: 10, font });
        
        // Since when at address
        if (dateAdresse) {
          const [day, month, year] = dateAdresse.split('/');
          page.drawText(day, { x: 50, y: 530, size: 10, font });
          page.drawText(month, { x: 70, y: 530, size: 10, font });
          page.drawText(year, { x: 100, y: 530, size: 10, font });
        }
        
        // Phone numbers
        page.drawText(telDomicile, { x: 400, y: 536, size: 10, font });
        page.drawText(telTravail, { x: 390, y: 524, size: 10, font });
        page.drawText(telAutre, { x: 410, y: 516, size: 10, font });
        
        // Criminal history
        if (infractionValue === 'Non') {
          page.drawText('X', { x: 58, y: 455, size: 12, font });
        } else if (infractionValue === 'Oui') {
          page.drawText('X', { x: 88, y: 455, size: 12, font });
          page.drawText(infractionDetail, { x: 110, y: 440, size: 10, font });
        }
        
        // Signature date (for both Parts B and C)
        if (dateSignature) {
          // For Part B
          const [day1, month1, year1] = dateSignature.split('/');
          page.drawText(day1, { x: 380, y: 260, size: 10, font });
          page.drawText(month1, { x: 405, y: 260, size: 10, font });
          page.drawText(year1, { x: 435, y: 260, size: 10, font });
          
          // For Part C
          const [day2, month2, year2] = dateSignature.split('/');
          page.drawText(day2, { x: 385, y: 180, size: 10, font });
          page.drawText(month2, { x: 410, y: 180, size: 10, font });
          page.drawText(year2, { x: 435, y: 180, size: 10, font });
        }
        
        // Add signature image for both signature lines
        try {
          // Convert signature data URL to bytes
          const signatureImageBytes = await fetch(signatureData).then(res => res.arrayBuffer());
          const signatureImage = await pdfDoc.embedPng(signatureImageBytes);
          
          // Size the signature appropriately
          const signatureDims = signatureImage.scale(0.2); // Scale signature to 20% of original size
          
          // Add signature to Part B
          page.drawImage(signatureImage, {
            x: 170,
            y: 250,
            width: signatureDims.width,
            height: signatureDims.height,
          });
          
          // Add signature to Part C
          page.drawImage(signatureImage, {
            x: 170,
            y: 170,
            width: signatureDims.width,
            height: signatureDims.height,
          });
        } catch (error) {
          console.error('Error embedding signature:', error);
          showStatus('error', texts.signatureError);
          return;
        }
        
        // Save the modified PDF
        const modifiedPdfBytes = await pdfDoc.save();
        generatedPdfBytes = modifiedPdfBytes;
        
        // Create a blob from the PDF bytes
        const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        // Set the PDF preview
        document.getElementById('pdfPreview').src = url;
        document.getElementById('pdfContainer').style.display = 'block';
        
        // Set up download button
        document.getElementById('downloadPdfBtn').onclick = function() {
          download(modifiedPdfBytes, 'filled_consent_form.pdf', 'application/pdf');
        };
        
        // Set up print button
        document.getElementById('printPdfBtn').onclick = function() {
          const iframe = document.getElementById('pdfPreview');
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
        };
        
        // Set up email PDF button
        document.getElementById('emailPdfBtn').onclick = sendEmailWithPDF;
        
        showStatus('success', texts.pdfSuccess);
        
      } catch (error) {
        console.error('Error processing PDF:', error);
        showStatus('error', texts.pdfError + error.message);
      }
    }

    // Send email with PDF attachment using Web3Forms
    async function sendEmailWithPDF() {
      const language = document.getElementById('languageToggle').checked ? 'french' : 'english';
      const texts = translations[language];
      const userEmail = document.getElementById('userEmail').value;
      
      if (!userEmail) {
        alert(texts.emailRequired);
        return;
      }
      
      if (!generatedPdfBytes) {
        alert('Please generate the PDF first.');
        return;
      }
      
      showStatus('loading', texts.emailSendingMsg);
      
      try {
        // Convert PDF bytes to base64
        const base64PDF = btoa(String.fromCharCode(...generatedPdfBytes));
        
        // Prepare form data for Web3Forms
        const formData = new FormData();
        formData.append('access_key', WEB3FORMS_ACCESS_KEY);
        formData.append('subject', 'New Quebec Background Check Form Submission');
        formData.append('from_name', `${document.getElementById('prenoms').value} ${document.getElementById('nom').value}`);
        formData.append('email', userEmail);
        formData.append('message', `
New Quebec Background Check Form Submission

Applicant Details:
- Name: ${document.getElementById('prenoms').value} ${document.getElementById('nom').value}
- Email: ${userEmail}
- Phone: ${document.getElementById('phoneNumber').value || 'Not provided'}
- Submission Date: ${new Date().toLocaleDateString()}

The completed PDF form is attached to this email.

Please contact the applicant if you need any additional information.
        `);
        
        // Create a PDF file from base64 data
        const pdfBlob = new Blob([generatedPdfBytes], { type: 'application/pdf' });
        formData.append('attachment', pdfBlob, 'quebec_background_check_form.pdf');
        
        // Web3Forms requires these specific fields
        formData.append('redirect', 'https://web3forms.com/success');
        formData.append('to', 'xcorelegacy@gmail.com'); // Your email
        formData.append('cc', userEmail); // Send copy to user
        
        // Send the form data to Web3Forms
        const response = await fetch('https://api.web3forms.com/submit', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          showStatus('success', texts.emailSuccess);
        } else {
          throw new Error(result.message || 'Failed to send email');
        }
        
      } catch (error) {
        console.error('Error sending email:', error);
        showStatus('error', texts.emailError + error.message);
      }
    }

    // Helper function to show status messages
    function showStatus(type, message) {
      const statusElement = document.getElementById('status');
      statusElement.className = type;
      statusElement.style.display = 'block';
      
      if (type === 'loading') {
        statusElement.innerHTML = `<div class="spinner"></div> ${message}`;
      } else {
        statusElement.textContent = message;
      }
      
      // Auto-hide non-loading status after 5 seconds
      if (type !== 'loading') {
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 5000);
      }
    }

    // Add JavaScript validation for numeric-only phone fields
    const phoneFields = ['telDomicile', 'telTravail', 'telAutre'];
    
    phoneFields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      
      field.addEventListener('input', function(e) {
        // Remove any non-numeric characters
        const numericValue = this.value.replace(/[^0-9]/g, '');
        
        // Update the field value if it changed
        if (this.value !== numericValue) {
          this.value = numericValue;
          
          // Update the character counter
          const counterElement = document.getElementById(`${fieldId}Counter`);
          if (counterElement) {
            counterElement.textContent = numericValue.length;
          }
        }
      });
    });

    // Character counter functionality
    const textInputs = [
      { id: 'nom', maxLength: 40 },
      { id: 'prenoms', maxLength: 40 },
      { id: 'nomNaissance', maxLength: 50 },
      { id: 'autreNoms', maxLength: 60 },
      { id: 'nomMere', maxLength: 50 },
      { id: 'adresse', maxLength: 80 },
      { id: 'ville', maxLength: 70 },
      { id: 'telDomicile', maxLength: 20 },
      { id: 'telTravail', maxLength: 20 },
      { id: 'telAutre', maxLength: 20 },
      { id: 'infractionDetails', maxLength: 150 }
    ];

    // Add input event listeners to update character counters
    textInputs.forEach(input => {
      const inputElement = document.getElementById(input.id);
      const counterElement = document.getElementById(`${input.id}Counter`);
      
      if (inputElement && counterElement) {
        // Update counter initially
        counterElement.textContent = inputElement.value.length;
        
        // Add input event listener
        inputElement.addEventListener('input', function() {
          counterElement.textContent = this.value.length;
          
          // Change counter color when approaching limit
          const charCount = this.value.length;
          const percent = charCount / input.maxLength;
          
          if (percent >= 0.9) {
            counterElement.parentElement.style.color = '#dc3545'; // Red when near limit
          } else if (percent >= 0.7) {
            counterElement.parentElement.style.color = '#fd7e14'; // Orange when getting close
          } else {
            counterElement.parentElement.style.color = '#6c757d'; // Default gray
          }
        });
      }
    });

    // Attach event listeners
    document.getElementById('fillPdfBtn').addEventListener('click', fillPDF);
    
    // Initialize language to English and load PDF
    setLanguage('english');
    loadPDF();
  </script>
</body>
</html>
