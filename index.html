<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quebec Background Check Form</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f8fafc;
      padding: 20px 0;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      padding: 32px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .header p {
      opacity: 0.9;
      font-size: 16px;
    }

    .language-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
    }

    .language-label {
      font-weight: 500;
      font-size: 14px;
    }

    .switch {
      position: relative;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.3);
      transition: .3s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: rgba(255, 255, 255, 0.5);
    }

    input:checked + .slider:before {
      transform: translateX(20px);
    }

    .form-content {
      padding: 40px;
    }

    .section {
      margin-bottom: 40px;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
    }

    .section-number {
      background: #3b82f6;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
    }

    .section-title {
      font-size: 24px;
      font-weight: 600;
      color: #1f2937;
    }

    .form-grid {
      display: grid;
      gap: 20px;
    }

    .form-grid.two-column {
      grid-template-columns: 1fr 1fr;
    }

    @media (max-width: 768px) {
      .form-grid.two-column {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    label {
      font-weight: 500;
      margin-bottom: 8px;
      color: #374151;
      font-size: 14px;
    }

    .required {
      color: #ef4444;
    }

    input[type="text"],
    input[type="date"],
    input[type="tel"],
    input[type="email"] {
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.2s;
      background: white;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="tel"]:focus,
    input[type="email"]:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    input::placeholder {
      color: #9ca3af;
    }

    .phone-input-container {
      position: relative;
    }

    .phone-validation-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      display: none;
    }

    .phone-validation-icon.valid {
      color: #10b981;
      display: block;
    }

    .phone-validation-icon.invalid {
      color: #ef4444;
      display: block;
    }

    .phone-input.valid {
      border-color: #10b981;
      background-color: #f0fdf4;
    }

    .phone-input.invalid {
      border-color: #ef4444;
      background-color: #fef2f2;
    }

    .phone-format-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
      font-style: italic;
    }

    .phone-error-message {
      font-size: 12px;
      color: #ef4444;
      margin-top: 4px;
      display: none;
    }

    .char-counter {
      font-size: 12px;
      color: #6b7280;
      text-align: right;
      margin-top: 4px;
    }

    .radio-group {
      display: flex;
      gap: 24px;
      margin-top: 8px;
    }

    .radio-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .radio-item input[type="radio"] {
      width: 18px;
      height: 18px;
      accent-color: #3b82f6;
    }

    .radio-item label {
      margin: 0;
      font-weight: 400;
      cursor: pointer;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .checkbox-item:hover {
      border-color: #d1d5db;
      background-color: #f9fafb;
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #3b82f6;
      margin-top: 2px;
    }

    .checkbox-item label {
      margin: 0;
      font-weight: 400;
      cursor: pointer;
      flex: 1;
    }

    .consent-section {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 24px;
      margin: 24px 0;
    }

    .consent-text {
      font-size: 14px;
      line-height: 1.6;
      color: #475569;
      margin-bottom: 20px;
    }

    .consent-checkboxes {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .consent-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .consent-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #3b82f6;
      margin-top: 2px;
    }

    .consent-checkbox label {
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      margin: 0;
    }

    .consent-description {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
      margin-left: 30px;
    }

    .signature-section {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      background: #fafafa;
    }

    .signature-canvas {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      cursor: crosshair;
      width: 100%;
      max-width: 600px;
      height: 200px;
    }

    .signature-instructions {
      margin-bottom: 16px;
      color: #6b7280;
      font-size: 14px;
    }

    .signature-actions {
      margin-top: 16px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-outline {
      background: transparent;
      color: #374151;
      border: 2px solid #e5e7eb;
    }

    .btn-outline:hover {
      border-color: #3b82f6;
      color: #3b82f6;
    }

    .button-group {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 32px;
    }

    .alert {
      padding: 16px;
      border-radius: 8px;
      margin: 20px 0;
      font-size: 14px;
      display: none;
    }

    .alert.success {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }

    .alert.error {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .alert.loading {
      background: #f0f9ff;
      color: #0c4a6e;
      border: 1px solid #bae6fd;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(12, 74, 110, 0.3);
      border-radius: 50%;
      border-top-color: #0c4a6e;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .pdf-preview-section {
      margin-top: 32px;
      padding: 24px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: white;
      text-align: center;
      display: none;
    }

    .pdf-preview {
      width: 100%;
      height: 600px;
      border: none;
      border-radius: 8px;
      margin-top: 20px;
    }

    .info-banner {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border: 1px solid #bfdbfe;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 32px;
    }

    .info-banner h3 {
      color: #1d4ed8;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .info-banner ul {
      color: #1e40af;
      font-size: 14px;
      margin-left: 20px;
    }

    .info-banner li {
      margin-bottom: 6px;
    }

    .email-section {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border: 2px solid #bbf7d0;
      border-radius: 12px;
      padding: 24px;
      margin-top: 32px;
    }

    .email-section h3 {
      color: #166534;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hidden {
      display: none !important;
    }

    /* Enhanced styles for email fallback and instructions */
    .email-fallback {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      max-width: 600px;
    }

    .email-fallback h4 {
      color: #92400e;
      margin: 0 0 12px 0;
    }

    .email-fallback p {
      margin: 0 0 12px 0;
      color: #92400e;
    }

    .email-details {
      background: white;
      padding: 12px;
      border-radius: 4px;
      margin: 12px 0;
      font-family: monospace;
      font-size: 14px;
      border: 1px solid #d1d5db;
    }

    .email-instructions-box {
      background: #ecfdf5;
      border: 2px solid #10b981;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      max-width: 600px;
    }

    .email-instructions-box h4 {
      color: #065f46;
      margin: 0 0 12px 0;
    }

    .email-instructions-box ol {
      color: #065f46;
      margin: 0;
      padding-left: 20px;
    }

    .manual-submission {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
      font-size: 14px;
    }

    .manual-submission h4 {
      color: #495057;
      margin: 0 0 8px 0;
      font-size: 16px;
    }

    .manual-submission p {
      margin: 4px 0;
      color: #6c757d;
    }

    @media (max-width: 768px) {
      .container {
        margin: 0 16px;
        border-radius: 8px;
      }
      
      .header {
        padding: 24px 20px;
      }
      
      .form-content {
        padding: 24px 20px;
      }
      
      .header h1 {
        font-size: 24px;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }

      .email-fallback,
      .email-instructions-box {
        margin: 20px -20px;
        border-radius: 0;
        border-left: none;
        border-right: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 id="pageTitle">Quebec Background Check Form</h1>
      <p id="pageSubtitle">Complete your background verification form digitally</p>
      
      <div class="language-toggle">
        <span class="language-label" id="englishLabel">English</span>
        <label class="switch">
          <input type="checkbox" id="languageToggle">
          <span class="slider"></span>
        </label>
        <span class="language-label" id="frenchLabel">Français</span>
      </div>
    </div>

    <div class="form-content">
      <div class="info-banner">
        <h3 id="howItWorksTitle">📋 How It Works</h3>
        <ul id="stepsList">
          <li id="step1">Fill out the form and add your digital signature</li>
          <li id="step2">Generate your completed PDF form</li>
          <li id="step3">Download the PDF to your device</li>
          <li id="step4">Submit via email to correctionalfacilities@aa87.org</li>
        </ul>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-number">1</div>
          <h2 class="section-title" id="involvementTitle">Involvement Information</h2>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="sobrietyDate" id="sobrietyDateLabel">Sobriety Date</label>
            <input type="date" id="sobrietyDate">
          </div>
          
          <div class="form-group full-width">
            <label id="involvementLabel">How are you looking to get involved?</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="joinCFC" name="involvement">
                <label for="joinCFC" id="joinCFCLabel">Join the CFC Committee</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="speakFacility" name="involvement">
                <label for="speakFacility" id="speakFacilityLabel">Speak at a Correctional Facility</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="tempContact" name="involvement">
                <label for="tempContact" id="tempContactLabel">Become a Temporary Contact for Bridging the Gap</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="seekingInfo" name="involvement">
                <label for="seekingInfo" id="seekingInfoLabel">Seeking information</label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-number">2</div>
          <h2 class="section-title" id="personalInfoTitle">Personal Information</h2>
        </div>
        
        <div class="form-grid two-column">
          <div class="form-group">
            <label for="prenoms" id="firstNameLabel">First Name <span class="required">*</span></label>
            <input type="text" id="prenoms" maxlength="40" placeholder="First name">
            <div class="char-counter"><span id="prenomsCounter">0</span>/40</div>
          </div>
          
          <div class="form-group">
            <label for="nom" id="lastNameLabel">Last Name <span class="required">*</span></label>
            <input type="text" id="nom" maxlength="40" placeholder="Last name">
            <div class="char-counter"><span id="nomCounter">0</span>/40</div>
          </div>
          
          <div class="form-group">
            <label for="nomNaissance" id="birthNameLabel">Name on birth certificate (if different)</label>
            <input type="text" id="nomNaissance" maxlength="50" placeholder="Birth certificate name">
            <div class="char-counter"><span id="nomNaissanceCounter">0</span>/50</div>
          </div>
          
          <div class="form-group">
            <label for="autreNoms" id="otherNamesLabel">Other names or nicknames</label>
            <input type="text" id="autreNoms" maxlength="60" placeholder="Other names">
            <div class="char-counter"><span id="autreNomsCounter">0</span>/60</div>
          </div>
          
          <div class="form-group">
            <label for="dateNaissance" id="dobLabel">Date of Birth <span class="required">*</span></label>
            <input type="date" id="dateNaissance">
          </div>
          
          <div class="form-group">
            <label id="genderLabel">Gender <span class="required">*</span></label>
            <div class="radio-group">
              <div class="radio-item">
                <input type="radio" id="sexeMasculin" name="sexe" value="Masculin">
                <label for="sexeMasculin" id="maleLabel">Male</label>
              </div>
              <div class="radio-item">
                <input type="radio" id="sexeFeminin" name="sexe" value="Féminin">
                <label for="sexeFeminin" id="femaleLabel">Female</label>
              </div>
            </div>
          </div>
          
          <div class="form-group full-width">
            <label for="nomMere" id="motherNameLabel">Mother's Full Name (First and Last) <span class="required">*</span></label>
            <input type="text" id="nomMere" maxlength="50" placeholder="Mother's full name">
            <div class="char-counter"><span id="nomMereCounter">0</span>/50</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-number">3</div>
          <h2 class="section-title" id="contactTitle">Contact Information</h2>
        </div>
        
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="adresse" id="addressLabel">Address <span class="required">*</span></label>
            <input type="text" id="adresse" maxlength="80" placeholder="Street address">
            <div class="char-counter"><span id="adresseCounter">0</span>/80</div>
          </div>
          
          <div class="form-group">
            <label for="ville" id="cityLabel">City <span class="required">*</span></label>
            <input type="text" id="ville" maxlength="70" placeholder="City">
            <div class="char-counter"><span id="villeCounter">0</span>/70</div>
          </div>
          
          <div class="form-group">
            <label for="postalCode" id="postalCodeLabel">Postal Code <span class="required">*</span></label>
            <input type="text" id="postalCode" maxlength="7" placeholder="A1A 1A1">
          </div>
          
          <div class="form-group">
            <label for="dateAdresse" id="addressDateLabel">Living at this address since</label>
            <input type="date" id="dateAdresse">
          </div>
          
          <div class="form-group">
            <label for="telDomicile" id="homePhoneLabel">Phone Number <span class="required">*</span></label>
            <div class="phone-input-container">
              <input type="tel" id="telDomicile" class="phone-input" maxlength="20" 
                     placeholder="(555) 123-4567" autocomplete="tel-national">
              <span class="phone-validation-icon" id="telDomicileIcon">✓</span>
            </div>
            <div class="phone-format-hint" id="telDomicileHint">Format: (XXX) XXX-XXXX or +1-XXX-XXX-XXXX</div>
            <div class="phone-error-message" id="telDomicileError"></div>
            <div class="char-counter"><span id="telDomicileCounter">0</span>/20</div>
          </div>
          
          <div class="form-group">
            <label for="userEmail" id="emailLabel">Email Address <span class="required">*</span></label>
            <input type="email" id="userEmail" placeholder="your.email@example.com">
          </div>
          
          <div class="form-group">
            <label for="telTravail" id="workPhoneLabel">Work Phone</label>
            <div class="phone-input-container">
              <input type="tel" id="telTravail" class="phone-input" maxlength="20" 
                     placeholder="(555) 123-4567" autocomplete="tel-work">
              <span class="phone-validation-icon" id="telTravailIcon">✓</span>
            </div>
            <div class="phone-format-hint" id="telTravailHint">Format: (XXX) XXX-XXXX or +1-XXX-XXX-XXXX</div>
            <div class="phone-error-message" id="telTravailError"></div>
            <div class="char-counter"><span id="telTravailCounter">0</span>/20</div>
          </div>
          
          <div class="form-group">
            <label for="telAutre" id="otherPhoneLabel">Other Phone Number</label>
            <div class="phone-input-container">
              <input type="tel" id="telAutre" class="phone-input" maxlength="20" 
                     placeholder="(555) 123-4567" autocomplete="tel">
              <span class="phone-validation-icon" id="telAutreIcon">✓</span>
            </div>
            <div class="phone-format-hint" id="telAutreHint">Format: (XXX) XXX-XXXX or +1-XXX-XXX-XXXX</div>
            <div class="phone-error-message" id="telAutreError"></div>
            <div class="char-counter"><span id="telAutreCounter">0</span>/20</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-number">4</div>
          <h2 class="section-title" id="backgroundTitle">Background Information</h2>
        </div>
        
        <div class="form-grid">
          <div class="form-group full-width">
            <label id="crimeLabel">Have you ever been found guilty of a criminal offense in Canada or elsewhere, or are you currently facing prosecution for such an offense? <span class="required">*</span></label>
            <div class="radio-group">
              <div class="radio-item">
                <input type="radio" id="infNon" name="infraction" value="Non">
                <label for="infNon" id="noLabel">No</label>
              </div>
              <div class="radio-item">
                <input type="radio" id="infOui" name="infraction" value="Oui">
                <label for="infOui" id="yesLabel">Yes</label>
              </div>
            </div>
          </div>
          
          <div class="form-group full-width hidden" id="infraDetail">
            <label for="infractionDetails" id="infractionDetailsLabel">If yes, please specify:</label>
            <input type="text" id="infractionDetails" maxlength="150" placeholder="Please provide details">
            <div class="char-counter"><span id="infractionDetailsCounter">0</span>/150</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-number">5</div>
          <h2 class="section-title" id="consentTitle">Consent & Digital Signature</h2>
        </div>
        
        <div class="consent-section">
          <div class="consent-text">
            <p>I, the undersigned, hereby consent to the Directorate General of Correctional Services of the Ministry of Public Security collecting information about my judicial and correctional background. This information will be used solely for the security screening required to authorize my access to individuals, locations, and sensitive information.</p>
            <p>I understand that the verification of my judicial and correctional background by the Directorate General of Correctional Services is a prerequisite for authorizing my access to individuals, locations, and sensitive information. I agree to inform the Directorate General of Correctional Services of any conviction under a law in force in Quebec during my employment contract, internship, or visit.</p>
          </div>
          
          <div class="consent-checkboxes">
            <div class="consent-checkbox">
              <input type="checkbox" id="consentBackground" required>
              <label for="consentBackground" id="consentBackgroundLabel">I consent to a background check</label>
            </div>
            <div class="consent-description" id="consentBackgroundDesc">
              I authorize the organization to conduct a comprehensive background verification for speaking engagements at correctional facilities.
            </div>
            
            <div class="consent-checkbox">
              <input type="checkbox" id="consentData" required>
              <label for="consentData" id="consentDataLabel">I consent to data processing</label>
            </div>
            <div class="consent-description" id="consentDataDesc">
              I understand that my personal information will be processed and stored securely for verification purposes only.
            </div>
          </div>
        </div>
        
        <div class="form-grid two-column">
          <div class="form-group">
            <label for="dateSignature" id="signDateLabel">Signature Date <span class="required">*</span></label>
            <input type="date" id="dateSignature">
          </div>
        </div>
        
        <div class="form-group">
          <label id="digitalSignatureLabel">Digital Signature <span class="required">*</span></label>
          <div class="signature-section">
            <div class="signature-instructions" id="signatureInstructions">
              Use your mouse or finger to sign above / Utilisez votre souris ou votre doigt pour signer ci-dessus
            </div>
            <canvas id="signatureCanvas" class="signature-canvas" width="600" height="200"></canvas>
            <div class="signature-actions">
              <button id="clearSignature" class="btn btn-outline">🗑️ Clear / Effacer</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Manual Submission Instructions -->
      <div class="manual-submission">
        <h4>Alternative Submission Methods:</h4>
        <p><strong>Email:</strong> correctionalfacilities@aa87.org</p>
        <p><strong>Subject:</strong> [Your Name] - Background Check Form</p>
        <p><strong>Required:</strong> Attach the completed PDF file</p>
      </div>

      <div class="button-group">
        <button type="button" id="fillPdfBtn" class="btn btn-primary">📄 Generate Completed Form</button>
        <button type="button" id="resetFormBtn" class="btn btn-outline">🔄 Reset Form</button>
      </div>

      <div id="status" class="alert"></div>

      <div id="pdfContainer" class="pdf-preview-section">
        <h3 id="completedFormTitle">✅ Your completed form is ready!</h3>
        <p id="downloadInstructions">Download your PDF and submit it via email.</p>
        
        <div class="email-section">
          <h3 id="emailTitle">📧 Submit Your Form</h3>
          <p id="emailInstructions">Click the button below to open your email client with a pre-filled message. Don't forget to attach the PDF file!</p>
          <div class="button-group">
            <button id="downloadPdfBtn" class="btn btn-primary">📥 Download PDF</button>
            <button id="sendFormBtn" class="btn btn-success">📧 Submit Form</button>
            <button id="printPdfBtn" class="btn btn-outline">🖨️ Print PDF</button>
          </div>
        </div>
        
        <iframe id="pdfPreview" class="pdf-preview"></iframe>
      </div>
    </div>
  </div>

  <script>
    // Google Apps Script Web App URL
    const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbyrQIR__UHpMgygUXQONyf6ygIJ8m1CqLpT7WDKcaQx82SGknCdVO6CG3OdayiS-Udm/exec';
    
    // Enhanced Phone Number Validation System
    class PhoneValidator {
      constructor() {
        this.canadianAreaCodes = [
          '204', '226', '236', '249', '250', '289', '306', '343', '365', '403', '416', '418',
          '431', '437', '438', '450', '506', '514', '519', '548', '579', '581', '587', '604',
          '613', '639', '647', '672', '705', '709', '778', '780', '782', '807', '819', '825',
          '867', '873', '902', '905'
        ];
      }

      cleanPhone(phone) {
        return phone.replace(/\D/g, '');
      }

      formatPhoneInput(phone) {
        const cleaned = this.cleanPhone(phone);
        if (cleaned.length === 0) return '';
        
        if (cleaned.startsWith('1') && cleaned.length > 1) {
          const digits = cleaned.substring(1);
          if (digits.length <= 3) {
            return `+1-${digits}`;
          } else if (digits.length <= 6) {
            return `+1-${digits.substring(0, 3)}-${digits.substring(3)}`;
          } else {
            return `+1-${digits.substring(0, 3)}-${digits.substring(3, 6)}-${digits.substring(6, 10)}`;
          }
        }
        
        if (cleaned.length <= 3) {
          return `(${cleaned}`;
        } else if (cleaned.length <= 6) {
          return `(${cleaned.substring(0, 3)}) ${cleaned.substring(3)}`;
        } else {
          return `(${cleaned.substring(0, 3)}) ${cleaned.substring(3, 6)}-${cleaned.substring(6, 10)}`;
        }
      }

      validatePhone(phone) {
        const cleaned = this.cleanPhone(phone);
        
        if (cleaned.length === 0) {
          return { isValid: true, message: '', type: 'empty' };
        }

        if (cleaned.length === 11 && cleaned.startsWith('1')) {
          const areaCode = cleaned.substring(1, 4);
          const exchange = cleaned.substring(4, 7);
          
          if (!this.canadianAreaCodes.includes(areaCode)) {
            return { isValid: false, message: 'Invalid Canadian area code', type: 'invalid_area_code' };
          }
          
          if (exchange.startsWith('0') || exchange.startsWith('1')) {
            return { isValid: false, message: 'Invalid exchange code', type: 'invalid_exchange' };
          }
          
          return { isValid: true, message: 'Valid Canadian number', type: 'canadian' };
        }
        
        if (cleaned.length === 10) {
          const areaCode = cleaned.substring(0, 3);
          const exchange = cleaned.substring(3, 6);
          
          if (!this.canadianAreaCodes.includes(areaCode)) {
            return { isValid: false, message: 'Invalid Canadian area code', type: 'invalid_area_code' };
          }
          
          if (exchange.startsWith('0') || exchange.startsWith('1')) {
            return { isValid: false, message: 'Invalid exchange code', type: 'invalid_exchange' };
          }
          
          return { isValid: true, message: 'Valid Canadian number', type: 'canadian' };
        }
        
        if (cleaned.length >= 10 && cleaned.length <= 15 && !cleaned.startsWith('1')) {
          return { isValid: true, message: 'Valid international number', type: 'international' };
        }
        
        if (cleaned.length < 10) {
          return { isValid: false, message: 'Phone number too short', type: 'too_short' };
        } else {
          return { isValid: false, message: 'Invalid phone number format', type: 'invalid_format' };
        }
      }

      setupPhoneField(fieldId) {
        const input = document.getElementById(fieldId);
        const icon = document.getElementById(`${fieldId}Icon`);
        const error = document.getElementById(`${fieldId}Error`);
        const counter = document.getElementById(`${fieldId}Counter`);
        
        if (!input) return;

        input.addEventListener('input', (e) => {
          const rawValue = e.target.value;
          const formatted = this.formatPhoneInput(rawValue);
          
          if (formatted !== rawValue) {
            const cursorPos = e.target.selectionStart;
            e.target.value = formatted;
            const newCursorPos = this.calculateCursorPosition(rawValue, formatted, cursorPos);
            e.target.setSelectionRange(newCursorPos, newCursorPos);
          }
          
          const validation = this.validatePhone(formatted);
          this.updateFieldValidation(input, icon, error, counter, validation, formatted);
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const cleaned = this.cleanPhone(paste);
          const formatted = this.formatPhoneInput(cleaned);
          e.target.value = formatted;
          
          const validation = this.validatePhone(formatted);
          this.updateFieldValidation(input, icon, error, counter, validation, formatted);
        });
      }

      calculateCursorPosition(oldValue, newValue, oldPos) {
        const oldCleaned = this.cleanPhone(oldValue.substring(0, oldPos));
        let newPos = 0;
        let cleanedCount = 0;
        
        for (let i = 0; i < newValue.length && cleanedCount < oldCleaned.length; i++) {
          if (/\d/.test(newValue[i])) {
            cleanedCount++;
          }
          newPos = i + 1;
        }
        
        return newPos;
      }

      updateFieldValidation(input, icon, error, counter, validation, value) {
        const cleaned = this.cleanPhone(value);
        
        if (counter) {
          counter.textContent = cleaned.length;
        }
        
        if (validation.type === 'empty') {
          input.classList.remove('valid', 'invalid');
          if (icon) icon.classList.remove('valid', 'invalid');
          if (error) error.style.display = 'none';
        } else if (validation.isValid) {
          input.classList.add('valid');
          input.classList.remove('invalid');
          if (icon) {
            icon.classList.add('valid');
            icon.classList.remove('invalid');
            icon.textContent = '✓';
          }
          if (error) error.style.display = 'none';
        } else {
          input.classList.add('invalid');
          input.classList.remove('valid');
          if (icon) {
            icon.classList.add('invalid');
            icon.classList.remove('valid');
            icon.textContent = '⚠';
          }
          if (error) {
            error.textContent = validation.message;
            error.style.display = 'block';
          }
        }
      }
    }

    // Canadian Postal Code Validator
    class PostalCodeValidator {
      validatePostalCode(postalCode) {
        const cleaned = postalCode.replace(/\s/g, '').toUpperCase();
        const canadianPattern = /^[A-Z]\d[A-Z]\d[A-Z]\d$/;
        return canadianPattern.test(cleaned);
      }

      formatPostalCode(postalCode) {
        const cleaned = postalCode.replace(/\s/g, '').toUpperCase();
        
        if (cleaned.length <= 3) {
          return cleaned;
        } else if (cleaned.length <= 6) {
          return `${cleaned.substring(0, 3)} ${cleaned.substring(3)}`;
        } else {
          return `${cleaned.substring(0, 3)} ${cleaned.substring(3, 6)}`;
        }
      }

      setupPostalCodeField(fieldId) {
        const input = document.getElementById(fieldId);
        if (!input) return;

        input.addEventListener('input', (e) => {
          const formatted = this.formatPostalCode(e.target.value);
          e.target.value = formatted;

          const isValid = this.validatePostalCode(formatted);
          if (isValid) {
            input.classList.add('valid');
            input.classList.remove('invalid');
          } else if (formatted.length > 0) {
            input.classList.add('invalid');
            input.classList.remove('valid');
          } else {
            input.classList.remove('valid', 'invalid');
          }
        });
      }
    }

    // Initialize validators
    const phoneValidator = new PhoneValidator();
    const postalCodeValidator = new PostalCodeValidator();
    
    // Language translations
    const translations = {
      english: {
        pageTitle: "Quebec Background Check Form",
        pageSubtitle: "Complete your background verification form digitally",
        howItWorksTitle: "📋 How It Works",
        step1: "Fill out the form and add your digital signature",
        step2: "Generate your completed PDF form", 
        step3: "Download the PDF to your device",
        step4: "Submit via email to correctionalfacilities@aa87.org",
        involvementTitle: "Involvement Information",
        sobrietyDateLabel: "Sobriety Date",
        involvementLabel: "How are you looking to get involved?",
        joinCFCLabel: "Join the CFC Committee",
        speakFacilityLabel: "Speak at a Correctional Facility",
        tempContactLabel: "Become a Temporary Contact for Bridging the Gap",
        seekingInfoLabel: "Seeking information",
        personalInfoTitle: "Personal Information",
        firstNameLabel: "First Name",
        lastNameLabel: "Last Name", 
        birthNameLabel: "Name on birth certificate (if different)",
        otherNamesLabel: "Other names or nicknames",
        dobLabel: "Date of Birth",
        genderLabel: "Gender",
        maleLabel: "Male",
        femaleLabel: "Female",
        motherNameLabel: "Mother's Full Name (First and Last)",
        contactTitle: "Contact Information",
        addressLabel: "Address",
        cityLabel: "City",
        postalCodeLabel: "Postal Code",
        addressDateLabel: "Living at this address since",
        homePhoneLabel: "Phone Number",
        emailLabel: "Email Address",
        workPhoneLabel: "Work Phone",
        otherPhoneLabel: "Other Phone Number",
        backgroundTitle: "Background Information",
        crimeLabel: "Have you ever been found guilty of a criminal offense in Canada or elsewhere, or are you currently facing prosecution for such an offense?",
        noLabel: "No",
        yesLabel: "Yes",
        infractionDetailsLabel: "If yes, please specify:",
        consentTitle: "Consent & Digital Signature",
        consentBackgroundLabel: "I consent to a background check",
        consentBackgroundDesc: "I authorize the organization to conduct a comprehensive background verification for speaking engagements at correctional facilities.",
        consentDataLabel: "I consent to data processing", 
        consentDataDesc: "I understand that my personal information will be processed and stored securely for verification purposes only.",
        signDateLabel: "Signature Date",
        digitalSignatureLabel: "Digital Signature",
        signatureInstructions: "Use your mouse or finger to sign above / Utilisez votre souris ou votre doigt pour signer ci-dessus",
        completedFormTitle: "✅ Your completed form is ready!",
        downloadInstructions: "Download your PDF and submit it via email.",
        emailTitle: "📧 Submit Your Form",
        emailInstructions: "Click the button below to open your email client with a pre-filled message. Don't forget to attach the PDF file!",
        processingMsg: "Generating your form... Please wait.",
        signatureRequired: "Please sign the form before generating the PDF.",
        pdfSuccess: "PDF form has been successfully generated!",
        pdfError: "Error processing the PDF: "
      },
      french: {
        pageTitle: "Formulaire de vérification d'antécédents du Québec",
        pageSubtitle: "Complétez votre formulaire de vérification des antécédents numériquement",
        howItWorksTitle: "📋 Comment ça marche",
        step1: "Remplissez le formulaire et ajoutez votre signature numérique",
        step2: "Générez votre formulaire PDF complété",
        step3: "Téléchargez le PDF sur votre appareil", 
        step4: "Soumettez par courriel à correctionalfacilities@aa87.org",
        involvementTitle: "Informations sur l'implication",
        sobrietyDateLabel: "Date de sobriété",
        involvementLabel: "Comment souhaitez-vous vous impliquer ?",
        joinCFCLabel: "Rejoindre le comité CFC",
        speakFacilityLabel: "Parler dans un établissement correctionnel",
        tempContactLabel: "Devenir un contact temporaire pour combler l'écart",
        seekingInfoLabel: "Recherche d'informations",
        personalInfoTitle: "Informations personnelles",
        firstNameLabel: "Prénom",
        lastNameLabel: "Nom de famille",
        birthNameLabel: "Nom sur l'acte de naissance (si différent)",
        otherNamesLabel: "Autres noms ou surnoms",
        dobLabel: "Date de naissance",
        genderLabel: "Sexe",
        maleLabel: "Masculin",
        femaleLabel: "Féminin", 
        motherNameLabel: "Nom complet de la mère (prénom et nom)",
        contactTitle: "Informations de contact",
        addressLabel: "Adresse",
        cityLabel: "Ville",
        postalCodeLabel: "Code postal",
        addressDateLabel: "Habitant à cette adresse depuis",
        homePhoneLabel: "Numéro de téléphone",
        emailLabel: "Adresse courriel",
        workPhoneLabel: "Téléphone travail",
        otherPhoneLabel: "Autre numéro de téléphone",
        backgroundTitle: "Informations sur les antécédents",
        crimeLabel: "Avez-vous déjà été reconnu coupable d'une infraction criminelle au Canada ou ailleurs, ou faites-vous actuellement l'objet de poursuites pour une telle infraction ?",
        noLabel: "Non",
        yesLabel: "Oui",
        infractionDetailsLabel: "Si oui, veuillez préciser :",
        consentTitle: "Consentement et signature numérique",
        consentBackgroundLabel: "Je consens à une vérification des antécédents",
        consentBackgroundDesc: "J'autorise l'organisation à effectuer une vérification complète des antécédents pour les engagements de prise de parole dans les établissements correctionnels.",
        consentDataLabel: "Je consens au traitement des données",
        consentDataDesc: "Je comprends que mes informations personnelles seront traitées et stockées en toute sécurité à des fins de vérification uniquement.",
        signDateLabel: "Date de signature",
        digitalSignatureLabel: "Signature numérique",
        signatureInstructions: "Utilisez votre souris ou votre doigt pour signer ci-dessus / Use your mouse or finger to sign above",
        completedFormTitle: "✅ Votre formulaire complété est prêt !",
        downloadInstructions: "Téléchargez votre PDF et soumettez-le par courriel.",
        emailTitle: "📧 Soumettez votre formulaire",
        emailInstructions: "Cliquez sur le bouton ci-dessous pour ouvrir votre client de messagerie avec un message pré-rempli. N'oubliez pas de joindre le fichier PDF !",
        processingMsg: "Génération de votre formulaire... Veuillez patienter.",
        signatureRequired: "Veuillez signer le formulaire avant de générer le PDF.",
        pdfSuccess: "Le formulaire PDF a été généré avec succès !",
        pdfError: "Erreur lors du traitement du PDF : "
      }
    };

    // Variables to store PDF data
    let pdfBytes = null;
    let generatedPdfBytes = null;

    // Function to change language
    function setLanguage(language) {
      const texts = translations[language];
      
      // Update all text elements
      Object.keys(texts).forEach(key => {
        const element = document.getElementById(key);
        if (element) {
          if (element.tagName === 'INPUT' && element.type === 'button') {
            element.value = texts[key];
          } else {
            element.textContent = texts[key];
          }
        }
      });
      
      // Update document language attribute
      document.documentElement.lang = language === 'english' ? 'en' : 'fr';
    }

    // Language toggle event listener
    document.getElementById('languageToggle').addEventListener('change', function() {
      const language = this.checked ? 'french' : 'english';
      setLanguage(language);
    });

    // Handle infraction details display
    document.querySelectorAll('input[name="infraction"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const infraDetail = document.getElementById('infraDetail');
        if (this.value === 'Oui') {
          infraDetail.classList.remove('hidden');
        } else {
          infraDetail.classList.add('hidden');
        }
      });
    });

    // Initialize signature pad
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let signatureData = null;

    // Setup canvas for drawing
    ctx.lineWidth = 2;
    ctx.strokeStyle = "black";
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Drawing functions
    function startDrawing(e) {
      isDrawing = true;
      draw(e);
    }

    function startDrawingTouch(e) {
      isDrawing = true;
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
      e.preventDefault();
    }

    function draw(e) {
      if (!isDrawing) return;
      
      ctx.lineCap = 'round';
      
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function drawTouch(e) {
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
      e.preventDefault();
    }

    function stopDrawing() {
      if (isDrawing) {
        ctx.beginPath();
        isDrawing = false;
        signatureData = canvas.toDataURL('image/png');
      }
    }

    // Add event listeners for drawing
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    canvas.addEventListener('touchstart', startDrawingTouch);
    canvas.addEventListener('touchmove', drawTouch);
    canvas.addEventListener('touchend', stopDrawing);

    // Clear signature button
    document.getElementById('clearSignature').addEventListener('click', function() {
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      signatureData = null;
    });

    // Auto-load PDF on page load
    async function loadPDF() {
      try {
        const response = await fetch('./Provincial consent form.pdf');
        if (!response.ok) {
          throw new Error('PDF not found');
        }
        const arrayBuffer = await response.arrayBuffer();
        pdfBytes = new Uint8Array(arrayBuffer);
        console.log('PDF template loaded successfully');
      } catch (error) {
        console.error('Error loading PDF:', error);
        const language = document.getElementById('languageToggle').checked ? 'french' : 'english';
        showStatus('error', 'Error loading the PDF template. Please try again.');
      }
    }

    // Fill PDF function
    async function fillPDF() {
      const language = document.getElementById('languageToggle').checked ? 'french' : 'english';
      const texts = translations[language];
      
      // Validate required fields
      const requiredFields = ['prenoms', 'nom', 'dateNaissance', 'nomMere', 'adresse', 'ville', 'postalCode', 'telDomicile', 'userEmail', 'dateSignature'];
      const missingFields = [];
      
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
          missingFields.push(field.previousElementSibling.textContent.replace(' *', ''));
        }
      });
      
      // Check gender selection
      const sexe = document.querySelector('input[name="sexe"]:checked');
      if (!sexe) {
        missingFields.push('Gender');
      }
      
      // Check criminal background selection
      const infraction = document.querySelector('input[name="infraction"]:checked');
      if (!infraction) {
        missingFields.push('Criminal background question');
      }
      
      // Check consent checkboxes
      if (!document.getElementById('consentBackground').checked) {
        missingFields.push('Background check consent');
      }
      if (!document.getElementById('consentData').checked) {
        missingFields.push('Data processing consent');
      }
      
      // Validate signature
      if (!signatureData) {
        missingFields.push('Digital signature');
      }
      
      if (missingFields.length > 0) {
        alert(`Please complete the following required fields:\n\n• ${missingFields.join('\n• ')}`);
        return;
      }
      
      // Check if PDF is loaded
      if (!pdfBytes) {
        await loadPDF();
        if (!pdfBytes) {
          return;
        }
      }
      
      showStatus('loading', texts.processingMsg);
      
      try {
        const { PDFDocument, StandardFonts } = PDFLib;
        
        // Load the existing PDF
        const pdfDoc = await PDFDocument.load(pdfBytes);
        const pages = pdfDoc.getPages();
        const page = pages[0];
        const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
        
        // Format dates (DD/MM/YYYY)
        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        };
        
        // Get form values
        const nom = document.getElementById('nom').value;
        const prenoms = document.getElementById('prenoms').value;
        const nomNaissance = document.getElementById('nomNaissance').value;
        const autreNoms = document.getElementById('autreNoms').value;
        const dateNaissance = formatDate(document.getElementById('dateNaissance').value);
        const sexeValue = sexe ? sexe.value : '';
        const nomMere = document.getElementById('nomMere').value;
        const adresse = document.getElementById('adresse').value;
        const ville = document.getElementById('ville').value;
        const postalCode = document.getElementById('postalCode').value;
        const dateAdresse = formatDate(document.getElementById('dateAdresse').value);
        const telDomicile = phoneValidator.cleanPhone(document.getElementById('telDomicile').value);
        const telTravail = phoneValidator.cleanPhone(document.getElementById('telTravail').value);
        const telAutre = phoneValidator.cleanPhone(document.getElementById('telAutre').value);
        const infractionValue = infraction ? infraction.value : '';
        const infractionDetail = document.getElementById('infractionDetails').value;
        const dateSignature = formatDate(document.getElementById('dateSignature').value);
        
        // Set coordinates for text placement on the PDF
        page.drawText(nom, { x: 170, y: 648, size: 10, font });
        page.drawText(prenoms, { x: 170, y: 700, size: 10, font });
        page.drawText(nomNaissance, { x: 400, y: 680, size: 10, font });
        page.drawText(autreNoms, { x: 400, y: 648, size: 10, font });
        
        // Date of birth
        if (dateNaissance) {
          const [day, month, year] = dateNaissance.split('/');
          page.drawText(day, { x: 50, y: 610, size: 10, font });
          page.drawText(month, { x: 70, y: 610, size: 10, font });
          page.drawText(year, { x: 100, y: 610, size: 10, font });
        }
        
        // Gender
        if (sexeValue === 'Masculin') {
          page.drawText('X', { x: 170, y: 610, size: 12, font });
        } else if (sexeValue === 'Féminin') {
          page.drawText('X', { x: 220, y: 610, size: 12, font });
        }
        
        page.drawText(nomMere, { x: 400, y: 605, size: 10, font });
        page.drawText(`${adresse}, ${ville}, ${postalCode}`, { x: 150, y: 560, size: 10, font });
        
        // Since when at address
        if (dateAdresse) {
          const [day, month, year] = dateAdresse.split('/');
          page.drawText(day, { x: 50, y: 530, size: 10, font });
          page.drawText(month, { x: 70, y: 530, size: 10, font });
          page.drawText(year, { x: 100, y: 530, size: 10, font });
        }
        
        // Phone numbers
        page.drawText(telDomicile, { x: 400, y: 536, size: 10, font });
        page.drawText(telTravail, { x: 390, y: 524, size: 10, font });
        page.drawText(telAutre, { x: 410, y: 516, size: 10, font });
        
        // Criminal history
        if (infractionValue === 'Non') {
          page.drawText('X', { x: 58, y: 455, size: 12, font });
        } else if (infractionValue === 'Oui') {
          page.drawText('X', { x: 88, y: 455, size: 12, font });
          page.drawText(infractionDetail, { x: 110, y: 440, size: 10, font });
        }
        
        // Signature date (for both Parts B and C)
        if (dateSignature) {
          const [day1, month1, year1] = dateSignature.split('/');
          page.drawText(day1, { x: 380, y: 260, size: 10, font });
          page.drawText(month1, { x: 405, y: 260, size: 10, font });
          page.drawText(year1, { x: 435, y: 260, size: 10, font });
          
          page.drawText(day1, { x: 385, y: 180, size: 10, font });
          page.drawText(month1, { x: 410, y: 180, size: 10, font });
          page.drawText(year1, { x: 435, y: 180, size: 10, font });
        }
        
        // Add signature image
        try {
          const signatureImageBytes = await fetch(signatureData).then(res => res.arrayBuffer());
          const signatureImage = await pdfDoc.embedPng(signatureImageBytes);
          const signatureDims = signatureImage.scale(0.2);
          
          page.drawImage(signatureImage, {
            x: 170, y: 250,
            width: signatureDims.width,
            height: signatureDims.height,
          });
          
          page.drawImage(signatureImage, {
            x: 170, y: 170,
            width: signatureDims.width,
            height: signatureDims.height,
          });
        } catch (error) {
          console.error('Error embedding signature:', error);
          showStatus('error', 'Error adding signature to the PDF.');
          return;
        }
        
        // Save the modified PDF
        const modifiedPdfBytes = await pdfDoc.save();
        generatedPdfBytes = modifiedPdfBytes;
        
        // Create a blob and preview
        const blob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        
        document.getElementById('pdfPreview').src = url;
        document.getElementById('pdfContainer').style.display = 'block';
        
        // Set up buttons
        document.getElementById('downloadPdfBtn').onclick = function() {
          download(modifiedPdfBytes, 'filled_consent_form.pdf', 'application/pdf');
        };
        
        document.getElementById('printPdfBtn').onclick = function() {
          const iframe = document.getElementById('pdfPreview');
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
        };
        
        document.getElementById('sendFormBtn').onclick = sendFormAndLogSubmission;
        
        showStatus('success', texts.pdfSuccess);
        
        // Scroll to PDF preview
        document.getElementById('pdfContainer').scrollIntoView({ behavior: 'smooth' });
        
      } catch (error) {
        console.error('Error processing PDF:', error);
        showStatus('error', texts.pdfError + error.message);
      }
    }

    // Enhanced send form function with better user feedback
    async function sendFormAndLogSubmission() {
      const language = document.getElementById('languageToggle').checked ? 'french' : 'english';
      
      showStatus('loading', 'Preparing submission...');
      
      try {
        // Log to Google Sheets first
        await logSubmissionToSheets();
        showStatus('success', 'Submission logged successfully!');
        
        // Show email instructions
        showEmailInstructions();
        
        // Wait a moment then open email
        setTimeout(() => {
          openMailtoLink();
        }, 1500);
        
      } catch (error) {
        console.error('Sheets logging error:', error);
        showStatus('error', 'Error logging submission: ' + error.message);
        
        // Still try to open email even if logging fails
        setTimeout(() => {
          openMailtoLink();
        }, 2000);
      }
    }

    // Improved mailto function with error handling and fallbacks
    function openMailtoLink() {
      const userEmail = document.getElementById('userEmail').value || 'your.email@example.com';
      const applicantName = `${document.getElementById('prenoms').value} ${document.getElementById('nom').value}`;
      const submissionDate = new Date().toLocaleDateString();
      
      // Shorter, more concise email body to avoid URL length limits
      const subject = encodeURIComponent(`${applicantName} - Background Check Form`);
      const body = encodeURIComponent(`Hello,

I am submitting my Quebec Background Check Form.

Name: ${applicantName}
Email: ${userEmail}
Date: ${submissionDate}

⚠️ PDF attachment required.

Thank you,
${applicantName}`);
      
      const mailtoLink = `mailto:correctionalfacilities@aa87.org?subject=${subject}&body=${body}`;
      
      // Try to open mailto link
      try {
        // Use location.href instead of window.open() - more reliable
        const beforeTime = Date.now();
        window.location.href = mailtoLink;
        
        // Check if user returned quickly (might indicate no email client)
        setTimeout(() => {
          const afterTime = Date.now();
          if (afterTime - beforeTime < 1000) {
            showMailtoFallback(userEmail, applicantName, submissionDate);
          }
        }, 500);
        
      } catch (error) {
        console.error('Mailto failed:', error);
        showMailtoFallback(userEmail, applicantName, submissionDate);
      }
    }

    // Fallback function when mailto doesn't work
    function showMailtoFallback(userEmail, applicantName, submissionDate) {
      const fallbackHTML = `
        <div class="email-fallback">
          <h4>📧 Email Client Not Available</h4>
          <p>Please manually send an email with the following details:</p>
          
          <div class="email-details">
            <strong>To:</strong> correctionalfacilities@aa87.org<br>
            <strong>Subject:</strong> ${applicantName} - Background Check Form<br><br>
            <strong>Message:</strong><br>
            Hello,<br><br>
            I am submitting my Quebec Background Check Form.<br><br>
            Name: ${applicantName}<br>
            Email: ${userEmail}<br>
            Date: ${submissionDate}<br><br>
            ⚠️ PDF attachment required.<br><br>
            Thank you,<br>
            ${applicantName}
          </div>
          
          <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
            <button onclick="copyEmailDetails('${applicantName}', '${userEmail}', '${submissionDate}')" 
                    class="btn btn-primary" style="margin: 0;">
              📋 Copy Email Details
            </button>
            <button onclick="this.parentElement.parentElement.style.display='none'" 
                    class="btn btn-outline" style="margin: 0;">
              ❌ Close
            </button>
          </div>
        </div>
      `;
      
      // Insert fallback after the status message
      const statusElement = document.getElementById('status');
      statusElement.insertAdjacentHTML('afterend', fallbackHTML);
    }

    // Copy email details to clipboard
    async function copyEmailDetails(applicantName, userEmail, submissionDate) {
      const emailText = `To: correctionalfacilities@aa87.org
Subject: ${applicantName} - Background Check Form

Hello,

I am submitting my Quebec Background Check Form.

Name: ${applicantName}
Email: ${userEmail}
Date: ${submissionDate}

⚠️ PDF attachment required.

Thank you,
${applicantName}`;

      try {
        await navigator.clipboard.writeText(emailText);
        alert('📋 Email details copied to clipboard! Paste into your email client.');
      } catch (error) {
        console.error('Copy failed:', error);
        // Fallback: show text in a popup for manual copying
        const textWindow = window.open('', '_blank', 'width=500,height=400');
        textWindow.document.write(`
          <html>
            <head><title>Email Details</title></head>
            <body style="font-family: Arial, sans-serif; padding: 20px;">
              <h3>Copy this text and paste into your email client:</h3>
              <textarea style="width: 100%; height: 250px; font-family: monospace;">${emailText}</textarea>
              <button onclick="window.close()" style="margin-top: 10px; padding: 8px 16px;">Close</button>
            </body>
          </html>
        `);
      }
    }

    // Show clear email instructions
    function showEmailInstructions() {
      const instructionsHTML = `
        <div class="email-instructions-box">
          <h4>📧 Next Steps</h4>
          <ol>
            <li><strong>Your email client should open automatically</strong></li>
            <li><strong>Attach the downloaded PDF file</strong></li>
            <li><strong>Send the email</strong></li>
          </ol>
          <p style="margin: 12px 0 0 0; font-size: 14px;">
            <strong>⚠️ Important:</strong> The PDF attachment is required - emails without the PDF will not be processed.
          </p>
        </div>
      `;
      
      const statusElement = document.getElementById('status');
      statusElement.insertAdjacentHTML('afterend', instructionsHTML);
    }

    // Log to Google Sheets
    async function logSubmissionToSheets() {
      const userEmail = document.getElementById('userEmail').value || 'Not provided';
      const applicantName = `${document.getElementById('prenoms').value} ${document.getElementById('nom').value}`;
      
      const involvementOptions = [];
      if (document.getElementById('joinCFC').checked) involvementOptions.push('Join the CFC Committee');
      if (document.getElementById('speakFacility').checked) involvementOptions.push('Speak at a Correctional Facility');
      if (document.getElementById('tempContact').checked) involvementOptions.push('Become a Temporary Contact for Bridging the Gap');
      if (document.getElementById('seekingInfo').checked) involvementOptions.push('Seeking information');
      
      const params = new URLSearchParams({
        applicantName: applicantName,
        firstName: document.getElementById('prenoms').value,
        lastName: document.getElementById('nom').value,
        gender: document.querySelector('input[name="sexe"]:checked')?.value || '',
        sobrietyDate: document.getElementById('sobrietyDate').value,
        involvement: involvementOptions.join(', '),
        signatureDate: document.getElementById('dateSignature').value,
        userEmail: userEmail,
        userPhone: phoneValidator.cleanPhone(document.getElementById('telDomicile').value)
      });
      
      const response = await fetch(`${GOOGLE_SHEETS_URL}?${params.toString()}`, {
        method: 'GET',
        mode: 'cors'
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      if (result.status !== 'success') {
        throw new Error(result.message || 'Unknown error occurred');
      }
      
      return result;
    }

    // Reset form button
    document.getElementById('resetFormBtn').addEventListener('click', function() {
      if (confirm('Are you sure you want to reset the entire form? This will clear all your data.')) {
        // Reset all form fields
        document.querySelectorAll('input[type="text"], input[type="tel"], input[type="date"], input[type="email"]').forEach(input => {
          input.value = '';
          input.classList.remove('valid', 'invalid');
        });
        
        document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
          input.checked = false;
        });
        
        // Reset validation UI
        document.querySelectorAll('.phone-validation-icon').forEach(icon => {
          icon.classList.remove('valid', 'invalid');
        });
        
        document.querySelectorAll('.phone-error-message').forEach(error => {
          error.style.display = 'none';
        });
        
        // Hide conditional fields
        document.getElementById('infraDetail').classList.add('hidden');
        
        // Clear signature
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
        signatureData = null;
        
        // Hide PDF container
        document.getElementById('pdfContainer').style.display = 'none';
        
        // Clear status and any inserted elements
        document.getElementById('status').style.display = 'none';
        document.querySelectorAll('.email-fallback, .email-instructions-box').forEach(el => el.remove());
        
        // Reset generated PDF
        generatedPdfBytes = null;
        
        // Reset signature date to today
        document.getElementById('dateSignature').value = new Date().toISOString().split('T')[0];
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });

    // Helper function to show status messages
    function showStatus(type, message) {
      const statusElement = document.getElementById('status');
      statusElement.className = `alert ${type}`;
      statusElement.style.display = 'block';
      
      if (type === 'loading') {
        statusElement.innerHTML = `<div class="spinner"></div> ${message}`;
      } else {
        statusElement.textContent = message;
      }
      
      if (type !== 'loading') {
        setTimeout(() => {
          statusElement.style.display = 'none';
        }, 5000);
      }
    }

    // Character counter functionality
    const textInputs = [
      { id: 'nom', maxLength: 40 },
      { id: 'prenoms', maxLength: 40 },
      { id: 'nomNaissance', maxLength: 50 },
      { id: 'autreNoms', maxLength: 60 },
      { id: 'nomMere', maxLength: 50 },
      { id: 'adresse', maxLength: 80 },
      { id: 'ville', maxLength: 70 },
      { id: 'infractionDetails', maxLength: 150 }
    ];

    textInputs.forEach(input => {
      const inputElement = document.getElementById(input.id);
      const counterElement = document.getElementById(`${input.id}Counter`);
      
      if (inputElement && counterElement) {
        counterElement.textContent = inputElement.value.length;
        
        inputElement.addEventListener('input', function() {
          counterElement.textContent = this.value.length;
          
          const charCount = this.value.length;
          const percent = charCount / input.maxLength;
          
          if (percent >= 0.9) {
            counterElement.style.color = '#ef4444';
          } else if (percent >= 0.7) {
            counterElement.style.color = '#f59e0b';
          } else {
            counterElement.style.color = '#6b7280';
          }
        });
      }
    });

    // Initialize everything
    document.addEventListener('DOMContentLoaded', function() {
      // Setup validators
      phoneValidator.setupPhoneField('telDomicile');
      phoneValidator.setupPhoneField('telTravail');
      phoneValidator.setupPhoneField('telAutre');
      postalCodeValidator.setupPostalCodeField('postalCode');
      
      // Set today's date as default signature date
      document.getElementById('dateSignature').value = new Date().toISOString().split('T')[0];
      
      // Attach event listeners
      document.getElementById('fillPdfBtn').addEventListener('click', fillPDF);
      
      // Initialize language and load PDF
      setLanguage('english');
      loadPDF();
    });
  </script>
</body>
</html>
